<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
:root{
  --primary:#1565c0;
  --secondary:#1e88e5;
  --success:#43a047;
  --danger:#e53935;
  --dark:#0d47a1;
}
*{box-sizing:border-box;font-family:'Segoe UI',Arial}

body{
  margin:0;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
}

header{
  background:var(--dark);
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:22px;
  letter-spacing:1px;
}

.container{
  max-width:1200px;
  margin:auto;
  padding:18px;
}

.card{
  background:#fff;
  border-radius:18px;
  padding:22px;
  margin-bottom:24px;
  box-shadow:0 15px 35px rgba(0,0,0,.3);
}

.card h3{
  margin-top:0;
  color:var(--dark);
  border-bottom:2px solid #e3f2fd;
  padding-bottom:6px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}

input,select{
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  width:100%;
}

.btn{
  padding:13px;
  border:none;
  border-radius:12px;
  font-size:15px;
  cursor:pointer;
  color:#fff;
  margin-top:12px;
}
.primary{background:var(--primary)}
.success{background:var(--success)}
.danger{background:var(--danger)}
.secondary{background:#546e7a}

.btn:hover{opacity:.9}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:14px;
}
th{
  background:var(--primary);
  color:#fff;
}
/* ===== Scrollable Table (Mobile Friendly) ===== */
.table-scroll{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  margin-top:12px;
}

/* Ensure table doesn’t shrink */
.table-scroll table{
  min-width:700px;
}

/* Mobile optimization */
@media(max-width:768px){
  th, td{
    white-space:nowrap;
    font-size:13px;
    padding:10px;
  }
}


@media(max-width:600px){
  header{font-size:18px}
}
</style>
</head>

<body>

<header>ADMIN – ONLINE ASSESSMENT PLATFORM</header>

<div class="container">

<!-- ================= CREATE / EDIT EXAM ================= -->
<div class="card">
<h3>Create / Edit Exam</h3>
<div class="grid">
<input id="exam_id" placeholder="Exam ID">
<input id="exam_name" placeholder="Exam Name">
<input id="partA_count" placeholder="Part A (1 Mark)">
<input id="partB_count" placeholder="Part B (2 Mark)">
<input id="duration_min" placeholder="Duration (minutes)">
<input id="violation_limit" placeholder="Violation Limit">

<select id="calculator">
  <option value="YES">Calculator Enabled</option>
  <option value="NO">Calculator Disabled</option>
</select>

<select id="review">
  <option value="YES">Review Enabled</option>
  <option value="NO">Review Disabled</option>
</select>

<input id="start_datetime" type="datetime-local">
<input id="end_datetime" type="datetime-local">

<select id="exam_status">
  <option value="ENABLED">Enabled</option>
  <option value="DISABLED">Disabled</option>
</select>
</div>

<button class="btn primary" onclick="createExam()">Create Exam</button>
<button class="btn secondary" onclick="updateExam()">Update Exam Status</button>
</div>

<!-- ================= EXAM LIST ================= -->
<div class="card">
<h3>Created Exams</h3>
<div class="table-scroll">
<table>
<thead>
<tr>
  <th>Exam ID</th>
  <th>Name</th>
  <th>Status</th>
  <th>Start</th>
  <th>End</th>
  <th>Edit</th>
</tr>
</thead>
<tbody id="examTable"></tbody>
</table>
</div>
</div>

<!-- ================= QUESTIONS ================= -->
<div class="card">
<h3>Add Question (Single)</h3>
<div class="grid">
<input id="q_exam_id" placeholder="Exam ID">
<select id="q_part">
  <option value="PART A">PART A</option>
  <option value="PART B">PART B</option>
</select>
<input id="q_qid" placeholder="Question ID">
<input id="q_question" placeholder="Question">
<input id="q_A" placeholder="Option A">
<input id="q_B" placeholder="Option B">
<input id="q_C" placeholder="Option C">
<input id="q_D" placeholder="Option D">
<input id="q_correct" placeholder="Correct (A/B/C/D)">
<input id="q_image" placeholder="Image URL (optional)">
</div>
<button class="btn success" onclick="addSingleQuestion()">Add Question</button>
</div>

<!-- ================= BULK UPLOAD ================= -->
<div class="card">
<h3>Bulk Upload</h3>
<input type="file" id="questionFile" accept=".csv">
<button class="btn primary" onclick="uploadQuestions()">Upload Questions</button>
<button class="btn secondary" onclick="downloadQuestionTemplate()">Question Template</button>

<hr>

<input type="file" id="studentFile" accept=".csv">
<button class="btn primary" onclick="uploadStudents()">Upload Students</button>
<button class="btn secondary" onclick="downloadStudentTemplate()">
  Student Template
</button>
</div>

<!-- ================= EXAM MAPPING ================= -->
<div class="card">
<h3>Bulk Exam – Student Mapping</h3>
<input type="file" id="mapFile" accept=".csv">
<button class="btn primary" onclick="uploadMapping()">Upload Mapping</button>
<button class="btn secondary" onclick="downloadMapTemplate()">Mapping Template</button>
</div>
<!-- ================= RESULTS MANAGEMENT ================= -->
<div class="card">
<h3>Student Results (Re-Enable Control)</h3>

<div class="grid">
  <input id="result_exam_id" placeholder="Enter Exam ID to View Results">
  <button class="btn primary" onclick="loadResults()">Load Results</button>
</div>

<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Exam ID</th>
        <th>Roll No</th>
        <th>Marks</th>
        <th>Violations</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="resultTable"></tbody>
  </table>
</div>

 <!-- ================= EXAM REPORT ================= -->
<div class="card">
<h3>Exam Report (Print / Export)</h3>

<div class="grid">
  <input id="rep_exam_id" placeholder="Exam ID">
  <input id="rep_exam_name" placeholder="Exam Name">
  <input id="rep_dept" placeholder="Department">
  <input id="rep_year" placeholder="Year">
  <input id="rep_section" placeholder="Section">
</div>

<button class="btn primary" onclick="generateReport()">Generate Report</button>
<button class="btn success" onclick="downloadExcel()">Download Excel</button>
<button class="btn secondary" onclick="downloadPDF()">Download PDF</button>

<div class="table-scroll">
  <table id="reportTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Roll No</th>
        <th>Student Name</th>
        <th>Total Marks</th>
        <th>Violations</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>

<!-- ================= LOGOUT ================= -->
<button class="btn danger" onclick="logout()">Logout</button>

</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw2-wsIEQVVZk3OqpbFqMumc9Nh2DvXUqiDp0zocIpTqRMwBZqgf5cL5LfwpkZfXGVX/exec";

/* ================= CREATE EXAM ================= */
function createExam(){
 if(!exam_id.value){ alert("Exam ID required"); return; }

 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({action:"getAllExams"})
 })
 .then(r=>r.json())
 .then(exams=>{
  const exists = exams.some(e => e[0] === exam_id.value);

  if(exists){
    alert("Exam ID already exists. Use UPDATE.");
    return;
  }

  fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"createExam",
      exam_id:exam_id.value,
      exam_name:exam_name.value,
      partA_count:partA_count.value,
      partB_count:partB_count.value,
      duration_min:duration_min.value,
      violation_limit:violation_limit.value,
      calculator:calculator.value,
      review:review.value,
      start_datetime:start_datetime.value,
      end_datetime:end_datetime.value
    })
  }).then(()=>{ alert("Exam Created"); loadExams(); });
 });
}


/* ================= UPDATE STATUS ================= */
function updateExam(){
 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({
   action:"updateExamDetails",
   exam_id:exam_id.value,
   exam_name:exam_name.value,
   partA_count:partA_count.value,
   partB_count:partB_count.value,
   duration_min:duration_min.value,
   violation_limit:violation_limit.value,
   calculator:calculator.value,
   review:review.value,
   start_datetime:start_datetime.value,
   end_datetime:end_datetime.value,
   status:exam_status.value
  })
 }).then(()=>{ alert("Exam Updated Successfully"); loadExams(); });
}

function downloadStudentTemplate(){
 downloadCSV(
  "email,password,roll_no,name,dept,year,section",
  "student_upload_template.csv"
 );
}

/* ================= LOAD EXAMS ================= */
function loadExams(){
 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({action:"getAllExams"})
 }).then(r=>r.json()).then(d=>{
  examTable.innerHTML="";
  d.forEach(ex=>{
   examTable.innerHTML+=`
    <tr>
      <td>${ex[0]}</td>
      <td>${ex[1]}</td>
      <td>${ex[10]}</td>
      <td>${ex[8]}</td>
      <td>${ex[9]}</td>
      <td><button class="btn primary" onclick='editExam(${JSON.stringify(ex)})'>Edit</button></td>
    </tr>`;
  });
 });
}

function editExam(ex){
 exam_id.value=ex[0];
 exam_name.value=ex[1];
 partA_count.value=ex[2];
 partB_count.value=ex[3];
 duration_min.value=ex[4];
 violation_limit.value=ex[5];
 calculator.value=ex[6];
 review.value=ex[7];
 start_datetime.value=ex[8];
 end_datetime.value=ex[9];
 exam_status.value=ex[10];
}

/* ================= QUESTIONS ================= */
function addSingleQuestion(){
 const q=[{
  exam_id:q_exam_id.value,part:q_part.value,qid:q_qid.value,
  question:q_question.value,optA:q_A.value,optB:q_B.value,
  optC:q_C.value,optD:q_D.value,correct:q_correct.value,image_url:q_image.value
 }];
 sendBulkQuestions(q);
}

function uploadQuestions(){
 parseCSV(questionFile.files[0],sendBulkQuestions);
}

function sendBulkQuestions(data){
 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({action:"bulkQuestions",json:JSON.stringify(data)})
 }).then(()=>alert("Questions Stored"));
}

/* ================= STUDENTS ================= */
function uploadStudents(){
 parseCSV(studentFile.files[0],data=>{
  fetch(WEBAPP_URL,{method:"POST",
   body:new URLSearchParams({action:"bulkStudents",json:JSON.stringify(data)})
  }).then(()=>alert("Students Added"));
 });
}

/* ================= MAPPING ================= */
function uploadMapping(){
 parseCSV(mapFile.files[0],data=>{
  data.forEach(m=>{
   fetch(WEBAPP_URL,{method:"POST",
    body:new URLSearchParams({
     action:"mapExam",
     exam_id:m.exam_id,
     roll_no:m.roll_no||"",
     dept:m.dept||"",
     year:m.year||"",
     section:m.section||""
    })
   });
  });
  alert("Mapping Completed");
 });
}

/* ================= CSV ================= */
function parseCSV(file,cb){
 if(!file){alert("Select CSV");return;}
 const r=new FileReader();
 r.onload=e=>{
  const rows=e.target.result.trim().split("\n");
  const h=rows.shift().split(",");
  const d=rows.map(r=>{
   const o={};
   r.split(",").forEach((v,i)=>o[h[i]]=v.trim());
   return o;
  });
  cb(d);
 };
 r.readAsText(file);
}

/* ================= TEMPLATES ================= */
function downloadQuestionTemplate(){
 downloadCSV("exam_id,part,qid,question,optA,optB,optC,optD,correct,image_url","question_template.csv");
}
function downloadMapTemplate(){
 downloadCSV("exam_id,roll_no,dept,year,section","exam_student_mapping_template.csv");
}
function downloadCSV(csv,name){
 const a=document.createElement("a");
 a.href="data:text/csv;charset=utf-8,"+csv;
 a.download=name;
 a.click();
}

/* ================= LOAD RESULTS ================= */

function loadResults(){

 const exam_id = result_exam_id.value.trim();

 if(!exam_id){
   alert("Please enter Exam ID");
   return;
 }

 fetch(
  WEBAPP_URL + "?action=getResults&exam_id=" + encodeURIComponent(exam_id),
  { method:"POST" }
 )
 .then(r=>r.json())
 .then(d=>{
  resultTable.innerHTML="";

  if(!d || d.length===0){
    resultTable.innerHTML =
      "<tr><td colspan='6'>No Results Found</td></tr>";
    return;
  }

  d.forEach(r=>{
    const exam   = r[0];
    const roll   = r[1];
    const marks  = r[2];
    const vio    = r[3];
    const status = r[4];

    resultTable.innerHTML += `
      <tr>
        <td>${exam}</td>
        <td>${roll}</td>
        <td>${marks}</td>
        <td>${vio}</td>
        <td><b>${status}</b></td>
        <td>
          ${
            status==="SUBMITTED"
            ? `<button class="btn success"
                 onclick="reenable('${exam}','${roll}')">
                 Re-Enable</button>`
            : "-"
          }
        </td>
      </tr>`;
  });
 })
 .catch(err=>{
   console.error(err);
   alert("Error loading results");
 });
}



/* ================= RE-ENABLE ================= */
function reenable(exam_id, roll_no){
 if(!confirm("Re-enable this student?")) return;
 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({
    action:"unblockStudent",
    exam_id,
    roll_no
  })
 }).then(()=>{ alert("Student Re-Enabled"); loadResults(); });
}



let REPORT_DATA = [];

function generateReport(){

  const exam_id = rep_exam_id.value.trim();
  const dept = rep_dept.value.trim();
  const year = rep_year.value.trim();
  const section = rep_section.value.trim();

  if(!exam_id){ alert("Enter Exam ID"); return; }

  fetch(WEBAPP_URL + "?action=getResults&exam_id=" + exam_id,{method:"POST"})
  .then(r=>r.json())
  .then(results=>{

    fetch(WEBAPP_URL + "?action=getViolations&exam_id=" + exam_id,{method:"POST"})
    .then(vio=>{

      fetch(WEBAPP_URL,{method:"POST",
        body:new URLSearchParams({action:"bulkStudents",json:"[]"})
      });

      REPORT_DATA=[];
      const tbody=document.querySelector("#reportTable tbody");
      tbody.innerHTML="";

      let sno=1;

      results.forEach(r=>{
        const roll=r[1], marks=r[2], v=r[3];

        REPORT_DATA.push([sno, roll, "", marks, v]);

        tbody.innerHTML+=`
        <tr>
          <td>${sno++}</td>
          <td>${roll}</td>
          <td>-</td>
          <td>${marks}</td>
          <td>${v}</td>
        </tr>`;
      });
    });
  });
}

/* ===== EXCEL ===== */
function downloadExcel(){
 if(!REPORT_DATA.length){alert("Generate report first");return;}
 const ws = XLSX.utils.aoa_to_sheet([
  ["COLLEGE NAME"],
  [],
  [`Exam ID: ${rep_exam_id.value}`],
  [`Exam Name: ${rep_exam_name.value}`],
  [`Dept: ${rep_dept.value} | Year: ${rep_year.value} | Section: ${rep_section.value}`],
  [],
  ["S.No","Roll No","Student Name","Total Marks","Violations"],
  ...REPORT_DATA
 ]);
 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "Report");
 XLSX.writeFile(wb,"Exam_Report.xlsx");
}

/* ===== PDF ===== */
function downloadPDF(){
 if(!REPORT_DATA.length){alert("Generate report first");return;}
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 doc.setFontSize(14);
 doc.text("COLLEGE NAME",105,15,{align:"center"});
 doc.setFontSize(11);
 doc.text(`Exam ID: ${rep_exam_id.value}`,14,25);
 doc.text(`Exam Name: ${rep_exam_name.value}`,14,32);
 doc.text(`Dept: ${rep_dept.value}   Year: ${rep_year.value}   Section: ${rep_section.value}`,14,39);

 doc.autoTable({
   startY:45,
   head:[["S.No","Roll No","Student Name","Total Marks","Violations"]],
   body:REPORT_DATA,
   theme:"grid",
   styles:{halign:"center"},
   headStyles:{fillColor:[21,101,192]}
 });

 doc.save("Exam_Report.pdf");
}



/* ================= LOGOUT ================= */
function logout(){
 sessionStorage.clear();
 location.href="index.html";
}

loadExams();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

</body>
</html>



