<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Examination</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ================= EXISTING CSS (UNCHANGED) ================= */
:root{
 --blue:#0d47a1; --green:#2e7d32;
 --orange:#fb8c00; --red:#c62828;
 --gray:#78909c; --bg:#eef2f7;
}
*{box-sizing:border-box;font-family:'Segoe UI',system-ui}
body{margin:0;background:var(--bg)}
header{
 position:sticky;top:0;z-index:50;
 background:linear-gradient(135deg,#0d47a1,#1976d2);
 color:#fff;padding:14px 18px;
 display:flex;justify-content:space-between;
 align-items:center;
 box-shadow:0 6px 20px rgba(0,0,0,.35)
}
header .grp{display:flex;gap:14px;align-items:flex-start}
.progress{height:6px;background:#bbdefb}
.progress span{display:block;height:100%;background:#2e7d32;width:0%;transition:.3s}
.main{display:flex;min-height:90vh}
.qbox{flex:1;background:#fff;padding:28px}
.palette{width:260px;background:#f7f9fc;padding:18px;border-left:1px solid #ddd}
.section{background:#e3f2fd;color:#0d47a1;padding:6px 14px;border-radius:16px;font-weight:600}
.option{background:#e3f2fd;padding:14px 16px;border-radius:14px;margin:12px 0;cursor:pointer}
.option.selected{background:linear-gradient(135deg,#2e7d32,#66bb6a);color:#fff}
.palette span{width:36px;height:36px;display:inline-block;margin:6px;border-radius:50%;text-align:center;line-height:36px;color:#fff;background:#b0bec5;font-weight:600}
.answered{background:#2e7d32!important}
.review{background:#fb8c00!important}
</style>
</head>

<body>

<script>
/* üîí HARD BLOCK RE-ENTRY */
if(sessionStorage.getItem("exam_submitted")==="YES"){
  location.replace("summary.html");
}
</script>

<header>
 <div class="grp">
  <i class="fa-solid fa-user-graduate"></i>
  <span id="studentInfo"></span>
 </div>
 <div class="grp">
  <div>‚è± <span id="timer">00:00</span></div>
  <div>‚ö† <span id="vio">0 / 0</span></div>
 </div>
</header>

<div class="progress"><span id="bar"></span></div>

<div class="main">
 <div class="qbox">
  <div id="loading" style="text-align:center;padding:40px;color:#78909c">
   ‚è≥ Loading questions‚Ä¶ Please wait
  </div>
  <div id="question"></div>
 </div>
 <div class="palette" id="palette"></div>
</div>

<script>
/* ================= GLOBAL STATE ================= */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxmFdZlBq4m_7SvJtVF9NbyGC-c_of2aqokQtyg81aH97WPo6AT56VvwKYGG_tz4XEq/exec";

const user = JSON.parse(sessionStorage.getItem("user"));
const exam_id = sessionStorage.getItem("exam_id");
studentInfo.innerText = `${user.name} (${user.roll})`;

let questions = [];
let index = 0;
let answers = {};
let duration = 0;
let limit = 0;
let partA = 0;
let partB = 0;

/* ‚úÖ FIX 1: DEFINE timerStarted */
let timerStarted = false;
let autoSubmitted = false;

/* ================= AUTO SUBMIT ================= */
function forceAutoSubmit(reason){
 if(autoSubmitted) return;
 autoSubmitted = true;
 console.warn("AUTO SUBMIT:", reason);
 sessionStorage.setItem("exam_submitted","YES");
 submitExam();
}

/* ================= FULLSCREEN ================= */
function forceFullscreen(){
 if(!document.fullscreenElement){
  document.documentElement.requestFullscreen().catch(()=>{});
 }
}
document.addEventListener("DOMContentLoaded", forceFullscreen);

/* üîí BACK BUTTON */
history.pushState(null,null,location.href);
window.addEventListener("popstate",()=>forceAutoSubmit("Browser Back"));

/* ================= FETCH META ‚Üí QUESTIONS ================= */
fetch(WEBAPP_URL,{
 method:"POST",
 body:new URLSearchParams({action:"getExamMeta", exam_id})
})
.then(r=>r.json())
.then(meta=>{
 duration = Number(meta.duration) * 60;
 limit = Number(meta.violation_limit);
 partA = Number(meta.partA);
 partB = Number(meta.partB);
 vio.innerText = `0 / ${limit}`;

 return fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({action:"getQuestions", exam_id})
 });
})
.then(r=>r.json())
.then(allQ=>{

 const shuffle = a => [...a].sort(()=>Math.random()-0.5);

 const A = shuffle(allQ.filter(q=>q[1]==="PART A")).slice(0, partA);
 const B = shuffle(allQ.filter(q=>q[1]==="PART B")).slice(0, partB);

 questions = A.concat(B);

 /* ‚úÖ FIX 2: HIDE LOADER IMMEDIATELY */
 document.getElementById("loading").style.display="none";

 drawPalette();
 loadQ();
 startTimer();
})
.catch(err=>{
 console.error(err);
 document.getElementById("loading").innerText =
  "Network slow‚Ä¶ questions loading, please wait";
});

/* ================= RENDER ================= */
function loadQ(){
 const q = questions[index];
 question.innerHTML = `
  <span class="section">${q[1]}</span>
  <h3>Q${index+1}. ${q[3]}</h3>
 `;
 bar.style.width = ((index+1)/questions.length*100)+"%";
}

function drawPalette(){
 palette.innerHTML="";
 questions.forEach((_,i)=>{
  palette.innerHTML+=`<span onclick="index=${i};loadQ()">${i+1}</span>`;
 });
}

/* ================= TIMER ================= */
function startTimer(){
 if(timerStarted) return;
 timerStarted = true;

 setInterval(()=>{
  const m=Math.floor(duration/60);
  const s=duration%60;
  timer.innerText=`${m}:${String(s).padStart(2,"0")}`;
  if(--duration<0) submitExam();
 },1000);
}

/* ================= SUBMIT ================= */
function submitExam(){
 const finalAnswers={};
 questions.forEach((q,i)=>{
  finalAnswers[q[2]] = answers[i]?.ans || "";
 });
 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({
   action:"submitExam",
   exam_id,
   roll_no:user.roll,
   answers_json:JSON.stringify(finalAnswers)
  })
 }).then(()=>location.replace("summary.html"));
}
</script>

</body>
</html>
