<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Examination</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>


<style>
:root{
 --blue:#0d47a1; --green:#2e7d32;
 --orange:#fb8c00; --red:#c62828;
 --gray:#78909c; --bg:#eef2f7;
}
*{box-sizing:border-box;font-family:'Segoe UI',system-ui}
body{margin:0;background:var(--bg)}

header{
 position:sticky;top:0;z-index:50;
 background:linear-gradient(135deg,#0d47a1,#1976d2);
 color:#fff;padding:14px 18px;
 display:flex;justify-content:space-between;
 align-items:center;box-shadow:0 6px 20px rgba(0,0,0,.35)
}
header .grp{display:flex;gap:14px;align-items:flex-start}

.progress{height:6px;background:#bbdefb}
.progress span{display:block;height:100%;background:#2e7d32;width:0%;transition:.3s}

.main{display:flex;min-height:90vh}
.qbox{flex:1;background:#fff;padding:28px}
.palette{
 width:260px;background:#f7f9fc;
 padding:18px;border-left:1px solid #ddd
}

/* ================= FOOTER ================= */
.footer {
  text-align: center;
  margin-top: 18px;
  font-size: 12px;
  color: #777;
}

.section{
 background:#e3f2fd;color:#0d47a1;
 padding:6px 14px;border-radius:16px;
 font-weight:600;display:inline-block
}
.qimg{
 max-width:100%;margin:14px auto;
 border-radius:14px;
 box-shadow:0 6px 18px rgba(0,0,0,.25)
}
.option{
 background:#e3f2fd;padding:14px 16px;
 border-radius:14px;margin:12px 0;
 cursor:pointer;transition:.2s;
 display:flex;gap:10px;align-items:center
}
.option:hover{background:#bbdefb}
.option.selected{
 background:linear-gradient(135deg,#2e7d32,#66bb6a);
 color:#fff
}

 /* Header Base */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 12px;
  background:#0d47a1;
  color:#fff;
  gap:8px;
}

/* Student Info */
.topbar .left{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  font-weight:600;
}

.topbar .left i{
  font-size:16px;
}

/* Right Section */
.topbar .right{
  display:flex;
  align-items:center;
  gap:6px;
}

/* Info Chips */
.chip{
  background:rgba(255,255,255,0.15);
  padding:4px 8px;
  border-radius:12px;
  font-size:12px;
  white-space:nowrap;
}

/* Calculator Button */
.calc-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  width:34px;
  height:34px;
  border-radius:50%;
  border:none;
  background:#455a64;
  color:#fff;
}

/* üîπ Mobile View */
@media (max-width:600px){
  .topbar{
    flex-direction:column;
    align-items:flex-start;
  }

  .topbar .right{
    width:100%;
    justify-content:space-between;
  }

  .chip{
    flex:1;
    text-align:center;
  }
}

/* üîπ Ultra Small Phones */
@media (max-width:400px){
  .left span{
    font-size:12px;
  }

  .chip{
    font-size:11px;
  }
}

.controls{margin-top:26px}
.btn{
 padding:10px 15px;border:none;
 border-radius:14px;color:#fff;
 cursor:pointer;font-size:12px;
 display:inline-flex;align-items:center;gap:8px
}
.next{background:#1976d2}
.mark{background:#fb8c00}
.submit{background:#c62828}
.submit:disabled{background:#b0bec5}

.palette span{
 width:36px;height:36px;
 display:inline-block;margin:6px;
 border-radius:50%;text-align:center;
 line-height:36px;color:#fff;
 background:#b0bec5;font-weight:600;
 cursor:pointer
}
.answered{background:#2e7d32!important}
.review{background:#fb8c00!important}

.legend span{margin-right:10px;font-size:13px}
.legend i{margin-right:4px}

.modal{
 position:fixed;inset:0;
 background:rgba(0,0,0,.6);
 display:none;align-items:center;
 justify-content:center;z-index:100
}
.modal-box{
 background:#fff;border-radius:18px;
 padding:24px;max-width:360px;
 width:90%;text-align:center
}

.calculator{
 position:fixed;right:20px;bottom:20px;
 width:300px;background:#263238;
 color:#fff;border-radius:18px;
 padding:16px;display:none;
 box-shadow:0 18px 40px rgba(0,0,0,.5);
 z-index:200
}
.calc-screen{
 width:100%;height:44px;
 background:#000;color:#0f0;
 font-size:18px;border:none;
 margin-bottom:10px;
 padding:6px;text-align:right
}
.calc-btn{
 width:22%;margin:1%;
 padding:10px;background:#37474f;
 color:#fff;border:none;
 border-radius:10px;cursor:pointer
}

/* üîí PROCTOR OVERLAY */
#proctorOverlay{
 position:fixed;inset:0;
 background:rgba(198,40,40,.95); /* üî¥ RED */
 color:#fff;
 display:none;
 z-index:1000;
 align-items:center;
 justify-content:center;
 text-align:center;
}

#proctorOverlay h2{
 font-size:26px;
 margin-bottom:10px;
}

#proctorOverlay.active{display:flex}

@media(max-width:900px){
 .main{flex-direction:column}
 .palette{width:100%;border-left:none;border-top:1px solid #ddd}
}

/* ‚è± TIMER CHIP */
.chip.time{
  background:#1e88e5;   /* Blue */
  color:#fff;
  font-size:15px;
  padding:6px 14px;
}

.chip.time span{
  font-size:20px;       /* Bigger timer number */
  font-weight:700;
}

/* ‚ö† VIOLATION CHIP */
.chip.vio{
  background:#c62828;   /* Red */
  color:#fff;
  font-size:15px;
  padding:6px 14px;
}

.chip.vio span{
  font-size:20px;       /* Bigger violation count */
  font-weight:700;
}
/* ================= CASIO FX-82ES PLUS THEME ================= */

.calculator{
  background:#0f1113;               /* Casio black body */
  border-radius:20px;
  box-shadow:0 20px 45px rgba(0,0,0,.7);
  border:2px solid #1c1f22;
}

/* CASIO BRAND HEADER */
.casio-head{
  display:flex;
  justify-content:space-between;
  font-weight:700;
  font-size:14px;
  color:#e0e0e0;
  margin-bottom:8px;
}

/* LCD SCREEN */
.casio-screen{
  background:#e6f3c6;               /* Casio green LCD */
  border:2px solid #9eb37a;
  border-radius:6px;
  padding:8px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.2);
}

.casio-screen input{
  color:#000;
  font-family:"Digital-7", monospace;
  font-size:22px;
}

/* MODE TEXT */
.casio-screen .mode{
  font-size:11px;
  font-weight:600;
  color:#2e7d32;
}

/* BUTTON GRID */
.casio-grid button{
  background:#2b2f33;               /* dark grey keys */
  color:#fff;
  border-radius:8px;
  box-shadow:0 3px 0 #111;
  font-weight:600;
}

/* NUMBER KEYS */
.casio-grid button:nth-child(n+13):nth-child(-n+28){
  background:#3a3f44;               /* lighter grey */
}

/* OPERATOR KEYS */
.casio-grid button:contains("+"),
.casio-grid button:contains("‚àí"),
.casio-grid button:contains("√ó"),
.casio-grid button:contains("√∑"){
  background:#4b4f55;
}

/* SHIFT KEY */
.casio-grid button.shift{
  background:#616161;
  color:#ffeb3b;
}

/* EQUAL KEY */
.casio-grid button.eq{
  background:#2e7d32;               /* green = key */
  color:#fff;
}

/* MEMORY KEYS */
.casio-grid button:nth-last-child(-n+4){
  background:#455a64;
}

/* PRESS EFFECT */
.casio-grid button:active{
  transform:translateY(2px);
  box-shadow:0 1px 0 #000;
}
/* ============ COMPACT MOBILE CASIO MODE ============ */
@media (max-width:600px){

  .calculator{
    width:260px;               /* compact width */
    right:10px;
    bottom:10px;
    padding:10px;
    border-radius:16px;
  }

  /* CASIO HEADER */
  .casio-head{
    font-size:12px;
    margin-bottom:6px;
  }

  /* LCD SCREEN */
  .casio-screen{
    padding:6px;
    margin-bottom:8px;
  }

  .casio-screen input{
    font-size:18px;            /* smaller digits */
  }

  .casio-screen .mode{
    font-size:10px;
  }

  /* BUTTON GRID */
  .casio-grid{
    gap:6px;
  }

  .casio-grid button{
    padding:9px;               /* compact keys */
    font-size:12px;
    border-radius:6px;
  }

  /* SHIFT key highlight */
  .casio-grid button.shift{
    font-size:11px;
  }

  /* EQUAL key */
  .casio-grid button.eq{
    font-size:14px;
  }
}

</style>
</head>

<body>

<header class="topbar">
  <div class="left">
    <i class="fa-solid fa-user-graduate"></i>
    <span id="studentInfo">Student Name</span>
  </div>

  <div class="right">
    <div class="chip time">
      ‚è± <span id="timer">00:00</span>
    </div>
    <div class="chip vio">
      ‚ö† <span id="vio">0 / 0</span>
    </div>

    <button id="calcBtn" class="calc-btn"
      onclick="toggleCalc()">
      <i class="fa-solid fa-calculator"></i>
    </button>
  </div>
</header>


<div class="progress"><span id="bar"></span></div>

<div class="main">
 <div class="qbox">
 <div id="loading" style="
 font-size:18px;
 color:#78909c;
 text-align:center;
 padding:40px 0;">
 ‚è≥ Loading questions‚Ä¶ Please wait
</div>

  <div id="question"></div>

  <div class="controls">
   <button class="btn mark" onclick="markReview()">
    <i class="fa-solid fa-bookmark"></i> Review
   </button>
   <button class="btn next" onclick="nextQ()">
    <i class="fa-solid fa-arrow-right"></i> Next
   </button>
   <button id="submitBtn" class="btn submit"
    onclick="confirmSubmit()" disabled>
    <i class="fa-solid fa-paper-plane"></i> Submit
   </button>
  </div>

  <div class="legend" style="margin-top:20px">
   <span><i class="fa-solid fa-circle" style="color:#b0bec5"></i> Unanswered</span>
   <span><i class="fa-solid fa-circle" style="color:#2e7d32"></i> Answered</span>
   <span><i class="fa-solid fa-circle" style="color:#fb8c00"></i> Review</span>
  </div>
 </div>

 <div class="palette" id="palette"></div>
</div>

<div class="modal" id="modal">
 <div class="modal-box">
  <h3>Submit Exam?</h3>
  <button class="btn submit" onclick="submitExam()">Yes</button>
  <button class="btn next" onclick="closeModal()">Cancel</button>
 </div>
</div>

<div id="proctorOverlay">
 <div>
  <h2>‚ö† Exam Security Alert</h2>
  <p id="proctorMsg"></p>
 </div>
</div>

<div class="calculator" id="calculator">
  <div class="casio-head">
    <span>CASIO</span>
    <span>fx-82ES PLUS</span>
  </div>

  <div class="casio-screen">
    <input id="calcScreen" readonly>
    <div class="mode" id="mode">DEG</div>
  </div>

  <div class="casio-grid">
    <button class="shift" onclick="toggleShift()">SHIFT</button>
    <button onclick="toggleAngle()">DRG</button>
    <button onclick="clearCalc()">AC</button>
    <button onclick="del()">DEL</button>

    <button onclick="fn('sin')">sin</button>
    <button onclick="fn('cos')">cos</button>
    <button onclick="fn('tan')">tan</button>
    <button onclick="fn('log')">log</button>

    <button onclick="fn('ln')">ln</button>
    <button onclick="calc('(')">(</button>
    <button onclick="calc(')')">)</button>
    <button onclick="calc('^')">x ∏</button>

    <button onclick="calc('7')">7</button>
    <button onclick="calc('8')">8</button>
    <button onclick="calc('9')">9</button>
    <button onclick="calc('/')">√∑</button>

    <button onclick="calc('4')">4</button>
    <button onclick="calc('5')">5</button>
    <button onclick="calc('6')">6</button>
    <button onclick="calc('*')">√ó</button>

    <button onclick="calc('1')">1</button>
    <button onclick="calc('2')">2</button>
    <button onclick="calc('3')">3</button>
    <button onclick="calc('-')">‚àí</button>

    <button onclick="calc('0')">0</button>
    <button onclick="calc('.')">.</button>
    <button onclick="ans()">Ans</button>
    <button onclick="calc('+')">+</button>

    <button onclick="calc('pi')">œÄ</button>
    <button onclick="calc('e')">e</button>
    <button onclick="sqrt()">‚àö</button>
    <button class="eq" onclick="calculate()">=</button>

    <button onclick="memAdd()">M+</button>
    <button onclick="memSub()">M-</button>
    <button onclick="memRecall()">MR</button>
    <button onclick="memClear()">MC</button>
  </div>
</div>


  <div class="footer">
    ¬© KCET - ECE Online Examination System
  </div>
</div>


<script>
let timerStarted = false;

 let examLoaded = false;
let isSubmitting = false;

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxmFdZlBq4m_7SvJtVF9NbyGC-c_of2aqokQtyg81aH97WPo6AT56VvwKYGG_tz4XEq/exec";


const user=JSON.parse(sessionStorage.getItem("user"));
const exam_id=sessionStorage.getItem("exam_id");
studentInfo.innerText=`${user.name} (${user.roll})`;

let questions=[],index=0,answers={},violations=0;
let violationLog=[],duration=0,limit=0,partA=0,partB=0;

const overlay=document.getElementById("proctorOverlay");
const proctorMsg=document.getElementById("proctorMsg");



/* FULLSCREEN */
function forceFullscreen(){
 if(!document.fullscreenElement){
  document.documentElement.requestFullscreen().catch(()=>{});
 }
}
document.addEventListener("DOMContentLoaded",forceFullscreen);
document.addEventListener("click",forceFullscreen);

/* VIOLATIONS */
function violate(type,auto=false){
 violations++;
 vio.innerText=`${violations} / ${limit}`;
 violationLog.push({type,time:new Date().toLocaleString()});
 proctorMsg.innerText =
  `Violation: ${type} | Remaining: ${limit - violations}`;
 overlay.classList.add("active");
 setTimeout(()=>overlay.classList.remove("active"),2000);
 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({action:"violation",exam_id,roll_no:user.roll,type})
 });
 if (violations >= limit && questions.length > 0) {
 submitExam();
}
}

/* VIOLATIONS 
function violate(type, auto=false){

  // üö´ ignore if already submitting
  if (isSubmitting || forceSubmitting) return;

  violations++;
  vio.innerText = `${violations} / ${limit}`;

  violationLog.push({
    type,
    time: new Date().toLocaleString()
  });

  proctorMsg.innerText =
    `Violation: ${type} | Remaining: ${limit - violations}`;

  overlay.classList.add("active");
  setTimeout(()=>overlay.classList.remove("active"), 2000);

  // üîÅ log violation (non-blocking)
  fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"violation",
      exam_id,
      roll_no:user.roll,
      type
    })
  });

  // üîí AUTO SUBMIT ON LIMIT (SAFE)
  if (violations >= limit && questions.length > 0) {

    if (forceSubmitting) return;
    forceSubmitting = true;

    freezeExamUI();        // üîí stop clicks
    clearInterval(timerRef); // ‚õî stop timer
    saveState();           // üíæ force answer save

    // ‚è≥ allow JS stack to settle
    setTimeout(()=>{
      submitExam("VIOLATION_LIMIT");
    }, 500);
  }
}*/





/* ================= STRICT PROCTOR EVENTS ================= */

/* ‚ùå Exit fullscreen */
document.addEventListener("fullscreenchange",()=>{
 if(!document.fullscreenElement){
  violate("Exit Fullscreen");
 }
});

/* ‚ùå Notification / call / lock / background */
document.addEventListener("visibilitychange",()=>{
 if(document.hidden){
  violate("App Hidden / Notification / Call / Screen Lock");
 }
});

/* ‚ùå Control center / quick app switch */
window.addEventListener("blur",()=>{
 violate("App Switch / Control Center Swipe");
});

/* ‚ùå Copy / cut / right click */
["copy","cut","contextmenu"].forEach(e=>{
 document.addEventListener(e,ev=>{
  ev.preventDefault();
  violate(e.toUpperCase());
 });
});

/* ‚ùå Reload / refresh */
window.addEventListener("beforeunload", (e)=>{
  if(isSubmitting) return; // ‚úÖ allow submit redirect

  if(questions.length > 0){
    violate("Page Reload / Refresh");
    e.preventDefault();
    e.returnValue = ""; // block accidental close
  }
});



/* EXAM META */
/* ================= EXAM META ‚Üí QUESTIONS (FIXED) ================= */

fetch(WEBAPP_URL,{
 method:"POST",
 body:new URLSearchParams({
   action:"getExamMeta",
   exam_id
 })
})
.then(r => r.json())
.then(meta => {

  if(meta.error){
    alert(meta.error);
    return;
  }

  /* 1Ô∏è‚É£ SET META FIRST */
  duration = Number(meta.duration) * 60;
  limit    = Number(meta.violation_limit);
  partA    = Number(meta.partA);
  partB    = Number(meta.partB);

  vio.innerText = `0 / ${limit}`;

  /* ================= CALCULATOR BACKEND CONTROL ================= */

const calcPermission =
  String(meta.calc || meta.calculator || "NO")
    .trim()
    .toUpperCase();

if (calcPermission === "YES") {
  // ‚úÖ ENABLE calculator
  calcBtn.style.display = "inline-flex";
} else {
  // ‚ùå DISABLE calculator
  calcBtn.style.display = "none";
  calculator.style.display = "none"; // force close if open
}


  /* 2Ô∏è‚É£ NOW FETCH QUESTIONS (SAFE) */
  return fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"getQuestions",
      exam_id
    })
  });
})
.then(r => r.json())
.then(allQ => {

  if(!Array.isArray(allQ) || allQ.length === 0){
    alert("No questions found");
    return;
  }

  /* 3Ô∏è‚É£ FILTER & SLICE */
  const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);

  const partAQuestions = allQ.filter(q => q[1] === "PART A");
  const partBQuestions = allQ.filter(q => q[1] === "PART B");

  const A = shuffle(partAQuestions).slice(0, partA);
  const B = shuffle(partBQuestions).slice(0, partB);

  questions = A.concat(B);

  if(!questions.length){
    alert("Question set empty ‚Äì check counts");
    return;
  }

  /* 4Ô∏è‚É£ FINAL INITIALIZATION */
  document.getElementById("loading").style.display = "none";
examLoaded = true;
  drawPalette();
  restoreState();
  loadQ();
  startTimer();
})
.catch(err=>{
  console.error(err);

  // ‚ùó Only show error if exam never loaded
  if(!examLoaded){
    alert("May Be Loaded Wait");
  }
});




function loadQ(){
  if(index < 0 || index >= questions.length){
    index = 0;
  }

  const q = questions[index];

  question.innerHTML = `
    <span class="section">${q[1]}</span>
    <h3>Q${index+1}. ${escapeHTML(q[3])}</h3>

    ${q[9] ? `<img class="qimg" src="${q[9]}">` : ""}

    ${["A","B","C","D"].map((o,i)=>`
      <div class="option ${answers[index]?.ans === o ? 'selected' : ''}"
        onclick="selectAns('${o}')">
        ${q[4+i]}
      </div>
    `).join("")}
  `;

  submitBtn.disabled = index !== questions.length - 1;
 //submitBtn.disabled = false
 //submitBtn.disabled = questions.length === 0;
 bar.style.width = ((index + 1) / questions.length * 100) + "%";
}


function selectAns(a){
  answers[index] = {
    qid: questions[index][2],
    ans: a
  };

  const p = document.getElementById("p"+index);
  if(p){
    p.classList.add("answered");
    p.classList.remove("review");
  }

  saveState();
  loadQ();   // üî• force redraw (important)
}

function escapeHTML(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


function drawPalette(){
  palette.innerHTML = "";
  questions.forEach((_, i)=>{
    palette.innerHTML += `
      <span id="p${i}" onclick="index=${i};loadQ()">
        ${i+1}
      </span>`;
  });
}

function markReview(){document.getElementById("p"+index).classList.add("review")}
function nextQ(){
  if(index < questions.length - 1){
    index++;
    saveState();
    loadQ();
  }
}


/* TIMER */
let timerRef=null;

function startTimer(){
  if(timerStarted) return;
  timerStarted = true;

  timerRef = setInterval(()=>{
    if(duration <= 0){
      clearInterval(timerRef);
      submitExam();
      return;
    }

    const m = Math.floor(duration / 60);
    const s = duration % 60;
    timer.innerText = `${m}:${String(s).padStart(2,"0")}`;
    duration--;
    submitExwm();
  },1000);
}



/* SUBMIT */
function confirmSubmit(){modal.style.display="flex"}
function closeModal(){modal.style.display="none"}

/*function submitExam(reason="USER_SUBMITTED"){
  if (isSubmitting) return;
  isSubmitting = true;

  clearInterval(timerRef);
  saveState();

  const finalAnswers = {};
  questions.forEach((q,i)=>{
    finalAnswers[String(q[2]).trim()] = answers[i]?.ans ?? "";
  });

  fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"submitExam",
      exam_id,
      roll_no:user.roll,
      answers_json: JSON.stringify(finalAnswers),
      violation_log: JSON.stringify(violationLog),
      total_violations: violations,
      submit_reason: reason
    })
  }).then(()=>{
    sessionStorage.setItem("exam_completed","YES");
    location.replace("summary.html");
  });
}
$/

function submitExam(){
  if (isSubmitting) return;   // üîí HARD STOP
  isSubmitting = true;

  clearInterval(timerRef);   // ‚õî STOP TIMER

  const finalAnswers = {};
  questions.forEach((q, i) => {
    finalAnswers[String(q[2]).trim()] =
      answers[i]?.ans || "";
  });

  fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"submitExam",
      exam_id,
      roll_no:user.roll,
      answers_json:JSON.stringify(finalAnswers),
      violation_log:JSON.stringify(violationLog),
      total_violations:violations
    })
  }).then(()=>{location.replace("summary.html"); // üîÅ SAFE REDIRECT
  });
}

/*function submitExam(){
  isSubmitting = true;   // ‚úÖ critical

 const finalAnswers={};
questions.forEach((q, i) => {
  finalAnswers[String(q[2]).trim()] =
    answers[i]?.ans || "";
});


 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({
   action:"submitExam",
   exam_id,
   roll_no:user.roll,
   answers_json:JSON.stringify(finalAnswers),
   violation_log:JSON.stringify(violationLog),
   total_violations:violations,
   //status:"SUBMITTED"
  })
 }).then(()=>location.href="summary.html");
}*/

function saveState(){
 sessionStorage.setItem("answers", JSON.stringify(answers));
 sessionStorage.setItem("index", index);
 sessionStorage.setItem("timeLeft", duration);
 sessionStorage.setItem("violations", violations);

}

function restoreState(){
 const savedSig = sessionStorage.getItem("qSignature");
 const currentSig = questions.map(q=>q[2]).join(",");

 if(savedSig !== currentSig){
 sessionStorage.removeItem("answers");
 sessionStorage.removeItem("index");
 sessionStorage.removeItem("timeLeft");
 sessionStorage.removeItem("violations");
 answers = {};
 index = 0;
 return;
}

 if(sessionStorage.getItem("answers")){
   answers = JSON.parse(sessionStorage.getItem("answers"));
   index = Number(sessionStorage.getItem("index") || 0);
   duration = Number(sessionStorage.getItem("timeLeft") || duration);
   violations = Number(sessionStorage.getItem("violations") || 0);
   vio.innerText=`${violations} / ${limit}`;
 }
}

/* CALCULATOR */
function toggleCalc(){
 calculator.style.display=calculator.style.display=="block"?"none":"block";
}

const calculator = document.getElementById("calculator");
const calcScreen = document.getElementById("calcScreen");

let SHIFT=false;
let ANGLE="DEG";
let MEMORY=0;
let ANSWER=0;

function toggleShift(){
  SHIFT=!SHIFT;
}

function toggleAngle(){
  ANGLE = ANGLE==="DEG" ? "RAD" : ANGLE==="RAD" ? "GRAD" : "DEG";
  document.getElementById("mode").innerText = ANGLE;
}

function calc(v){
  calcScreen.value += v;
}

function fn(f){
  if(SHIFT){
    if(f==="sin") calcScreen.value+="asin(";
    if(f==="cos") calcScreen.value+="acos(";
    if(f==="tan") calcScreen.value+="atan(";
    SHIFT=false;
  }else{
    calcScreen.value+=f+"(";
  }
}

function sqrt(){
  calcScreen.value+="sqrt(";
}

function del(){
  calcScreen.value=calcScreen.value.slice(0,-1);
}

function clearCalc(){
  calcScreen.value="";
}

function ans(){
  calcScreen.value+=ANSWER;
}

function memAdd(){ MEMORY+=Number(calcScreen.value||0); }
function memSub(){ MEMORY-=Number(calcScreen.value||0); }
function memRecall(){ calcScreen.value+=MEMORY; }
function memClear(){ MEMORY=0; }

function calculate(){
  try{
    let scope={
      sin:x=>math.sin(conv(x)),
      cos:x=>math.cos(conv(x)),
      tan:x=>math.tan(conv(x)),
      asin:x=>math.asin(x),
      acos:x=>math.acos(x),
      atan:x=>math.atan(x),
      log:x=>math.log10(x),
      ln:x=>math.log(x),
      pi:math.pi,
      e:math.e,
      sqrt:x=>math.sqrt(x)
    };
    let res=math.evaluate(calcScreen.value,scope);
    ANSWER=res;
    calcScreen.value=res;
  }catch{
    calcScreen.value="Error";
  }
}

function conv(x){
  if(ANGLE==="DEG") return math.unit(x,"deg");
  if(ANGLE==="GRAD") return math.unit(x*0.9,"deg");
  return x;
}


</script>
</body>
</html>