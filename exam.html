<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Examination</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>


<style>
:root{
 --blue:#0d47a1; --green:#2e7d32;
 --orange:#fb8c00; --red:#c62828;
 --gray:#78909c; --bg:#eef2f7;
}
*{box-sizing:border-box;font-family:'Segoe UI',system-ui}
body{margin:0;background:var(--bg)}

header{
 position:sticky;top:0;z-index:50;
 background:linear-gradient(135deg,#0d47a1,#1976d2);
 color:#fff;padding:14px 18px;
 display:flex;justify-content:space-between;
 align-items:center;box-shadow:0 6px 20px rgba(0,0,0,.35)
}
header .grp{display:flex;gap:14px;align-items:flex-start}

.progress{height:6px;background:#bbdefb}
.progress span{display:block;height:100%;background:#2e7d32;width:0%;transition:.3s}

.main{display:flex;min-height:90vh}
.qbox{flex:1;background:#fff;padding:28px}
.palette{
 width:260px;background:#f7f9fc;
 padding:18px;border-left:1px solid #ddd
}

.section{
 background:#e3f2fd;color:#0d47a1;
 padding:6px 14px;border-radius:16px;
 font-weight:600;display:inline-block
}
.qimg{
 max-width:100%;margin:14px auto;
 border-radius:14px;
 box-shadow:0 6px 18px rgba(0,0,0,.25)
}
.option{
 background:#e3f2fd;padding:14px 16px;
 border-radius:14px;margin:12px 0;
 cursor:pointer;transition:.2s;
 display:flex;gap:10px;align-items:center
}
.option:hover{background:#bbdefb}
.option.selected{
 background:linear-gradient(135deg,#2e7d32,#66bb6a);
 color:#fff
}

 /* Header Base */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 12px;
  background:#0d47a1;
  color:#fff;
  gap:8px;
}

/* Student Info */
.topbar .left{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  font-weight:600;
}

.topbar .left i{
  font-size:16px;
}

/* Right Section */
.topbar .right{
  display:flex;
  align-items:center;
  gap:6px;
}

/* Info Chips */
.chip{
  background:rgba(255,255,255,0.15);
  padding:4px 8px;
  border-radius:12px;
  font-size:12px;
  white-space:nowrap;
}

/* Calculator Button */
.calc-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  width:34px;
  height:34px;
  border-radius:50%;
  border:none;
  background:#455a64;
  color:#fff;
}

/* üîπ Mobile View */
@media (max-width:600px){
  .topbar{
    flex-direction:column;
    align-items:flex-start;
  }

  .topbar .right{
    width:100%;
    justify-content:space-between;
  }

  .chip{
    flex:1;
    text-align:center;
  }
}

/* üîπ Ultra Small Phones */
@media (max-width:400px){
  .left span{
    font-size:12px;
  }

  .chip{
    font-size:11px;
  }
}

.controls{margin-top:26px}
.btn{
 padding:12px 20px;border:none;
 border-radius:14px;color:#fff;
 cursor:pointer;font-size:14px;
 display:inline-flex;align-items:center;gap:8px
}
.next{background:#1976d2}
.mark{background:#fb8c00}
.submit{background:#c62828}
.submit:disabled{background:#b0bec5}

.palette span{
 width:36px;height:36px;
 display:inline-block;margin:6px;
 border-radius:50%;text-align:center;
 line-height:36px;color:#fff;
 background:#b0bec5;font-weight:600;
 cursor:pointer
}
.answered{background:#2e7d32!important}
.review{background:#fb8c00!important}

.legend span{margin-right:10px;font-size:13px}
.legend i{margin-right:4px}

.modal{
 position:fixed;inset:0;
 background:rgba(0,0,0,.6);
 display:none;align-items:center;
 justify-content:center;z-index:100
}
.modal-box{
 background:#fff;border-radius:18px;
 padding:24px;max-width:360px;
 width:90%;text-align:center
}

.calculator{
 position:fixed;right:20px;bottom:20px;
 width:300px;background:#263238;
 color:#fff;border-radius:18px;
 padding:16px;display:none;
 box-shadow:0 18px 40px rgba(0,0,0,.5);
 z-index:200
}
.calc-screen{
 width:100%;height:44px;
 background:#000;color:#0f0;
 font-size:18px;border:none;
 margin-bottom:10px;
 padding:6px;text-align:right
}
.calc-btn{
 width:22%;margin:1%;
 padding:10px;background:#37474f;
 color:#fff;border:none;
 border-radius:10px;cursor:pointer
}

/* üîí PROCTOR OVERLAY */
#proctorOverlay{
 position:fixed;inset:0;
 background:rgba(198,40,40,.95); /* üî¥ RED */
 color:#fff;
 display:none;
 z-index:1000;
 align-items:center;
 justify-content:center;
 text-align:center;
}

#proctorOverlay h2{
 font-size:26px;
 margin-bottom:10px;
}

#proctorOverlay.active{display:flex}

@media(max-width:900px){
 .main{flex-direction:column}
 .palette{width:100%;border-left:none;border-top:1px solid #ddd}
}
</style>
</head>

<body>

<header class="topbar">
  <div class="left">
    <i class="fa-solid fa-user-graduate"></i>
    <span id="studentInfo">Student Name</span>
  </div>

  <div class="right">
    <div class="chip time">
      ‚è± <span id="timer">00:00</span>
    </div>
    <div class="chip vio">
      ‚ö† <span id="vio">0 / 0</span>
    </div>

    <button id="calcBtn" class="calc-btn"
      onclick="toggleCalc()">
      <i class="fa-solid fa-calculator"></i>
    </button>
  </div>
</header>


<div class="progress"><span id="bar"></span></div>

<div class="main">
 <div class="qbox">
 <div id="loading" style="
 font-size:18px;
 color:#78909c;
 text-align:center;
 padding:40px 0;">
 ‚è≥ Loading questions‚Ä¶ Please wait
</div>

  <div id="question"></div>

  <div class="controls">
   <button class="btn mark" onclick="markReview()">
    <i class="fa-solid fa-bookmark"></i> Review
   </button>
   <button class="btn next" onclick="nextQ()">
    <i class="fa-solid fa-arrow-right"></i> Next
   </button>
   <button id="submitBtn" class="btn submit"
    onclick="confirmSubmit()" disabled>
    <i class="fa-solid fa-paper-plane"></i> Submit
   </button>
  </div>

  <div class="legend" style="margin-top:20px">
   <span><i class="fa-solid fa-circle" style="color:#b0bec5"></i> Unanswered</span>
   <span><i class="fa-solid fa-circle" style="color:#2e7d32"></i> Answered</span>
   <span><i class="fa-solid fa-circle" style="color:#fb8c00"></i> Review</span>
  </div>
 </div>

 <div class="palette" id="palette"></div>
</div>

<div class="modal" id="modal">
 <div class="modal-box">
  <h3>Submit Exam?</h3>
  <button class="btn submit" onclick="submitExam()">Yes</button>
  <button class="btn next" onclick="closeModal()">Cancel</button>
 </div>
</div>

<div id="proctorOverlay">
 <div>
  <h2>‚ö† Exam Security Alert</h2>
  <p id="proctorMsg"></p>
 </div>
</div>

<div class="calculator" id="calculator">
  <input class="calc-screen" id="calcScreen" readonly>

  <div style="display:flex;flex-wrap:wrap;gap:6px">
    <button class="calc-btn" onclick="calc('sin(')">sin</button>
    <button class="calc-btn" onclick="calc('cos(')">cos</button>
    <button class="calc-btn" onclick="calc('tan(')">tan</button>
    <button class="calc-btn" onclick="calc('log(')">log</button>

    <button class="calc-btn" onclick="calc('7')">7</button>
    <button class="calc-btn" onclick="calc('8')">8</button>
    <button class="calc-btn" onclick="calc('9')">9</button>
    <button class="calc-btn" onclick="calc('/')">√∑</button>

    <button class="calc-btn" onclick="calc('4')">4</button>
    <button class="calc-btn" onclick="calc('5')">5</button>
    <button class="calc-btn" onclick="calc('6')">6</button>
    <button class="calc-btn" onclick="calc('*')">√ó</button>

    <button class="calc-btn" onclick="calc('1')">1</button>
    <button class="calc-btn" onclick="calc('2')">2</button>
    <button class="calc-btn" onclick="calc('3')">3</button>
    <button class="calc-btn" onclick="calc('-')">‚àí</button>

    <button class="calc-btn" onclick="calc('0')">0</button>
    <button class="calc-btn" onclick="calc('.')">.</button>
    <button class="calc-btn" onclick="calculate()">=</button>
    <button class="calc-btn" onclick="calc('+')">+</button>
<button class="calc-btn" onclick="calc('sqrt(')">‚àö</button>
<button class="calc-btn" onclick="calc('pi')">œÄ</button>
<button class="calc-btn" onclick="calc('^')">x ∏</button>
<button class="calc-btn" onclick="calc('ln(')">ln</button>

    <button class="calc-btn" onclick="clearCalc()">C</button>
    <button class="calc-btn" onclick="calc('(')">(</button>
    <button class="calc-btn" onclick="calc(')')">)</button>
  </div>
</div>


<script>
let timerStarted = false;

 let examLoaded = false;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxmFdZlBq4m_7SvJtVF9NbyGC-c_of2aqokQtyg81aH97WPo6AT56VvwKYGG_tz4XEq/exec";


const user=JSON.parse(sessionStorage.getItem("user"));
const exam_id=sessionStorage.getItem("exam_id");
studentInfo.innerText=`${user.name} (${user.roll})`;

let questions=[],index=0,answers={},violations=0;
let violationLog=[],duration=0,limit=0,partA=0,partB=0;

const overlay=document.getElementById("proctorOverlay");
const proctorMsg=document.getElementById("proctorMsg");



/* FULLSCREEN */
function forceFullscreen(){
 if(!document.fullscreenElement){
  document.documentElement.requestFullscreen().catch(()=>{});
 }
}
document.addEventListener("DOMContentLoaded",forceFullscreen);
document.addEventListener("click",forceFullscreen);

/* VIOLATIONS */
function violate(type,auto=false){
 violations++;
 vio.innerText=`${violations} / ${limit}`;
 violationLog.push({type,time:new Date().toLocaleString()});
 proctorMsg.innerText =
  `Violation: ${type} | Remaining: ${limit - violations}`;
 overlay.classList.add("active");
 setTimeout(()=>overlay.classList.remove("active"),2000);
 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({action:"violation",exam_id,roll_no:user.roll,type})
 });
 if (violations >= limit && questions.length > 0) {
 submitExam();
}

}

/* ================= STRICT PROCTOR EVENTS ================= */

/* ‚ùå Exit fullscreen */
document.addEventListener("fullscreenchange",()=>{
 if(!document.fullscreenElement){
  violate("Exit Fullscreen");
 }
});

/* ‚ùå Notification / call / lock / background */
document.addEventListener("visibilitychange",()=>{
 if(document.hidden){
  violate("App Hidden / Notification / Call / Screen Lock");
 }
});

/* ‚ùå Control center / quick app switch */
window.addEventListener("blur",()=>{
 violate("App Switch / Control Center Swipe");
});

/* ‚ùå Copy / cut / right click */
["copy","cut","contextmenu"].forEach(e=>{
 document.addEventListener(e,ev=>{
  ev.preventDefault();
  violate(e.toUpperCase());
 });
});

/* ‚ùå Reload / refresh */
window.addEventListener("beforeunload",()=>{
  if(questions.length > 0){
    violate("Page Reload / Refresh");
  }
});


/* EXAM META */
/* ================= EXAM META ‚Üí QUESTIONS (FIXED) ================= */

fetch(WEBAPP_URL,{
 method:"POST",
 body:new URLSearchParams({
   action:"getExamMeta",
   exam_id
 })
})
.then(r => r.json())
.then(meta => {

  if(meta.error){
    alert(meta.error);
    return;
  }

  /* 1Ô∏è‚É£ SET META FIRST */
  duration = Number(meta.duration) * 60;
  limit    = Number(meta.violation_limit);
  partA    = Number(meta.partA);
  partB    = Number(meta.partB);

  vio.innerText = `0 / ${limit}`;

  if(meta.calculator === "YES"){
    calcBtn.style.display = "inline-flex";
  }

  /* 2Ô∏è‚É£ NOW FETCH QUESTIONS (SAFE) */
  return fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"getQuestions",
      exam_id
    })
  });
})
.then(r => r.json())
.then(allQ => {

  if(!Array.isArray(allQ) || allQ.length === 0){
    alert("No questions found");
    return;
  }

  /* 3Ô∏è‚É£ FILTER & SLICE */
  const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);

  const partAQuestions = allQ.filter(q => q[1] === "PART A");
  const partBQuestions = allQ.filter(q => q[1] === "PART B");

  const A = shuffle(partAQuestions).slice(0, partA);
  const B = shuffle(partBQuestions).slice(0, partB);

  questions = A.concat(B);

  if(!questions.length){
    alert("Question set empty ‚Äì check counts");
    return;
  }

  /* 4Ô∏è‚É£ FINAL INITIALIZATION */
  document.getElementById("loading").style.display = "none";
examLoaded = true;
  drawPalette();
  restoreState();
  loadQ();
  startTimer();
})
.catch(err=>{
  console.error(err);

  // ‚ùó Only show error if exam never loaded
  if(!examLoaded){
    alert("May Be Loaded Wait");
  }
});




function loadQ(){
  if(index < 0 || index >= questions.length){
    index = 0;
  }

  const q = questions[index];

  question.innerHTML = `
    <span class="section">${q[1]}</span>
    <h3>Q${index+1}. ${escapeHTML(q[3])}</h3>

    ${q[9] ? `<img class="qimg" src="${q[9]}">` : ""}

    ${["A","B","C","D"].map((o,i)=>`
      <div class="option ${answers[index]?.ans === o ? 'selected' : ''}"
        onclick="selectAns('${o}')">
        ${q[4+i]}
      </div>
    `).join("")}
  `;

  submitBtn.disabled = index !== questions.length - 1;
 //submitBtn.disabled = false
 //submitBtn.disabled = questions.length === 0;
 bar.style.width = ((index + 1) / questions.length * 100) + "%";
}


function selectAns(a){
  answers[index] = {
    qid: questions[index][2],
    ans: a
  };

  const p = document.getElementById("p"+index);
  if(p){
    p.classList.add("answered");
    p.classList.remove("review");
  }

  saveState();
  loadQ();   // üî• force redraw (important)
}

function escapeHTML(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


function drawPalette(){
  palette.innerHTML = "";
  questions.forEach((_, i)=>{
    palette.innerHTML += `
      <span id="p${i}" onclick="index=${i};loadQ()">
        ${i+1}
      </span>`;
  });
}

function markReview(){document.getElementById("p"+index).classList.add("review")}
function nextQ(){
  if(index < questions.length - 1){
    index++;
    saveState();
    loadQ();
  }
}


/* TIMER */
let timerRef=null;

function startTimer(){
  if(timerStarted) return;   // ‚õî prevents duplicate timers
  timerStarted = true;

  timerRef = setInterval(()=>{
    const m = Math.floor(duration / 60);
    const s = duration % 60;
    timer.innerText = `${m}:${String(s).padStart(2,"0")}`;
    duration--;
    saveState();
    if(duration < 0) submitExam();
  },1000);
}



/* SUBMIT */
function confirmSubmit(){modal.style.display="flex"}
function closeModal(){modal.style.display="none"}

function submitExam(){
 const finalAnswers={};
questions.forEach((q, i) => {
  finalAnswers[String(q[2]).trim()] =
    answers[i]?.ans || "";
});


 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({
   action:"submitExam",
   exam_id,
   roll_no:user.roll,
   answers_json:JSON.stringify(finalAnswers),
   violation_log:JSON.stringify(violationLog),
   total_violations:violations,
   //status:"SUBMITTED"
  })
 }).then(()=>location.href="summary.html");
}

function saveState(){
 sessionStorage.setItem("answers", JSON.stringify(answers));
 sessionStorage.setItem("index", index);
 sessionStorage.setItem("timeLeft", duration);
 sessionStorage.setItem("violations", violations);
 
}

function restoreState(){
 const savedSig = sessionStorage.getItem("qSignature");
 const currentSig = questions.map(q=>q[2]).join(",");

 if(savedSig !== currentSig){
 sessionStorage.removeItem("answers");
 sessionStorage.removeItem("index");
 sessionStorage.removeItem("timeLeft");
 sessionStorage.removeItem("violations");
 answers = {};
 index = 0;
 return;
}

 if(sessionStorage.getItem("answers")){
   answers = JSON.parse(sessionStorage.getItem("answers"));
   index = Number(sessionStorage.getItem("index") || 0);
   duration = Number(sessionStorage.getItem("timeLeft") || duration);
   violations = Number(sessionStorage.getItem("violations") || 0);
   vio.innerText=`${violations} / ${limit}`;
 }
}

/* CALCULATOR */
function toggleCalc(){
 calculator.style.display=calculator.style.display=="block"?"none":"block";
}

const calculator = document.getElementById("calculator");
const calcScreen = document.getElementById("calcScreen");

/* Toggle */
function toggleCalc(){
  calculator.style.display =
    calculator.style.display === "block" ? "none" : "block";
}

/* Append value */
function calc(v){
  calcScreen.value += v;
}

/* Clear */
function clearCalc(){
  calcScreen.value = "";
}

/* SAFE CALCULATION USING MATH.JS */
function calculate(){
  try{
    const result = math.evaluate(calcScreen.value, {
      sin: math.sin,
      cos: math.cos,
      tan: math.tan,
      log: math.log10,   // base-10
      ln: math.log,      // natural log
      pi: math.pi,
      e: math.e
    });
    calcScreen.value = result;
  }catch(err){
    calcScreen.value = "Error";
  }
}


</script>
</body>
</html> 
