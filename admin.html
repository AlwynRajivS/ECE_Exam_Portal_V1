<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
/* ===== ORIGINAL STYLES (UNCHANGED) ===== */
:root{
  --primary:#1565c0;
  --secondary:#1e88e5;
  --success:#43a047;
  --danger:#e53935;
  --dark:#0d47a1;
}
*{box-sizing:border-box;font-family:'Segoe UI',Arial}
body{
  margin:0;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
}
header{
  background:var(--dark);
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:22px;
}
.container{max-width:1200px;margin:auto;padding:18px}
.card{
  background:#fff;border-radius:18px;padding:22px;margin-bottom:24px;
  box-shadow:0 15px 35px rgba(0,0,0,.3);
}
.card h3{
  margin-top:0;color:var(--dark);
  border-bottom:2px solid #e3f2fd;padding-bottom:6px;
}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
input,select{padding:12px;border-radius:10px;border:1px solid #ccc;width:100%}
.btn{
  padding:13px;border:none;border-radius:12px;
  font-size:15px;cursor:pointer;color:#fff;margin-top:12px
}
.primary{background:var(--primary)}
.success{background:var(--success)}
.secondary{background:#546e7a}
.danger{background:var(--danger)}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:14px}
th{background:var(--primary);color:#fff}
.table-scroll{width:100%;overflow-x:auto;margin-top:12px}
</style>
</head>

<body>

<header>ADMIN – ONLINE ASSESSMENT PLATFORM</header>
<div class="container">

<!-- ================= EXISTING MODULES (UNCHANGED) ================= -->
<!-- YOUR ORIGINAL CODE CONTINUES HERE WITHOUT MODIFICATION -->
<!-- (Create Exam, Exam List, Questions, Bulk Upload, Mapping, Results) -->

<!-- ================= EXAM REPORT (NEW – SAFE ADDITION) ================= -->
<div class="card">
<h3>Exam Report (Print / Export)</h3>

<div class="grid">
  <select id="rep_exam_id"></select>
  <input id="rep_exam_name" placeholder="Exam Name">
  <input id="rep_dept" placeholder="Department">
  <input id="rep_year" placeholder="Year">
  <input id="rep_section" placeholder="Section">
</div>

<button class="btn primary" onclick="generateReport()">Generate Report</button>
<button class="btn success" onclick="downloadExcel()">Download Excel</button>
<button class="btn secondary" onclick="downloadPDF()">Download PDF</button>

<div class="table-scroll">
<table id="reportTable">
<thead>
<tr>
  <th>S.No</th>
  <th>Roll No</th>
  <th>Student Name</th>
  <th>Total Marks</th>
  <th>Violations</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<button class="btn danger" onclick="logout()">Logout</button>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyv4rYwt1P_579hiz9px5jIphcAye7H1r83aDtmK-8VOwH9LuVSniU8TbRIZKWgxs5e/exec";

/* ===== LOAD EXAM DROPDOWN FROM BACKEND ===== */
fetch(WEBAPP_URL,{method:"POST",
 body:new URLSearchParams({action:"getAllExams"})
})
.then(r=>r.json())
.then(exams=>{
  rep_exam_id.innerHTML='<option value="">Select Exam ID</option>';
  exams.forEach(e=>{
    rep_exam_id.innerHTML+=`<option value="${e[0]}">${e[0]}</option>`;
  });
  rep_exam_id.onchange=()=>{
    const ex=exams.find(x=>x[0]===rep_exam_id.value);
    rep_exam_name.value=ex?ex[1]:"";
  };
});

let REPORT_DATA=[];

/* ===== GENERATE REPORT ===== */
function generateReport(){
  if(!rep_exam_id.value){alert("Select Exam ID");return;}

  fetch(WEBAPP_URL+"?action=getResults&exam_id="+rep_exam_id.value,{method:"POST"})
  .then(r=>r.json())
  .then(data=>{
    REPORT_DATA=[];
    const tb=document.querySelector("#reportTable tbody");
    tb.innerHTML="";
    let i=1;
    data.forEach(r=>{
      REPORT_DATA.push([i,r[1],"-",r[2],r[3]]);
      tb.innerHTML+=`
      <tr>
        <td>${i++}</td>
        <td>${r[1]}</td>
        <td>-</td>
        <td>${r[2]}</td>
        <td>${r[3]}</td>
      </tr>`;
    });
  });
}

/* ===== EXCEL ===== */
function downloadExcel(){
 if(!REPORT_DATA.length){alert("Generate report first");return;}
 const ws=XLSX.utils.aoa_to_sheet([
  ["COLLEGE NAME"],[],
  ["Exam ID: "+rep_exam_id.value],
  ["Exam Name: "+rep_exam_name.value],
  ["Dept: "+rep_dept.value+" | Year: "+rep_year.value+" | Section: "+rep_section.value],[],
  ["S.No","Roll No","Student Name","Total Marks","Violations"],
  ...REPORT_DATA
 ]);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Report");
 XLSX.writeFile(wb,"Exam_Report.xlsx");
}

/* ===== PDF ===== */
function downloadPDF(){
 if(!REPORT_DATA.length){alert("Generate report first");return;}
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 doc.text("COLLEGE NAME",105,15,{align:"center"});
 doc.text("Exam ID: "+rep_exam_id.value,14,25);
 doc.text("Exam Name: "+rep_exam_name.value,14,32);
 doc.text(`Dept:${rep_dept.value}  Year:${rep_year.value}  Section:${rep_section.value}`,14,39);
 doc.autoTable({
  startY:45,
  head:[["S.No","Roll No","Student Name","Total Marks","Violations"]],
  body:REPORT_DATA,
  theme:"grid"
 });
 doc.save("Exam_Report.pdf");
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

</body>
</html>
