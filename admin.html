<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
:root{
  --primary:#1565c0;
  --secondary:#1e88e5;
  --success:#43a047;
  --danger:#e53935;
  --dark:#0d47a1;
}
*{box-sizing:border-box;font-family:'Segoe UI',Arial}

body{
  margin:0;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
}

header{
  background:var(--dark);
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:22px;
  letter-spacing:1px;
}

/* ================= FOOTER ================= */
.footer {
  text-align: center;
  margin-top: 18px;
  font-size: 12px;
  color: #777;
}

.container{
  max-width:1200px;
  margin:auto;
  padding:18px;
}

.card{
  background:#fff;
  border-radius:18px;
  padding:22px;
  margin-bottom:24px;
  box-shadow:0 15px 35px rgba(0,0,0,.3);
}

.card h3{
  margin-top:0;
  color:var(--dark);
  border-bottom:2px solid #e3f2fd;
  padding-bottom:6px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}

input,select{
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  width:100%;
}

.btn{
  padding:13px;
  border:none;
  border-radius:12px;
  font-size:15px;
  cursor:pointer;
  color:#fff;
  margin-top:12px;
}
.primary{background:var(--primary)}
.success{background:var(--success)}
.danger{background:var(--danger)}
.secondary{background:#546e7a}

.btn:hover{opacity:.9}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:14px;
}
th{
  background:var(--primary);
  color:#fff;
}
/* ===== Scrollable Table (Mobile Friendly) ===== */
.table-scroll{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  margin-top:12px;
}

/* Ensure table doesn’t shrink */
.table-scroll table{
  min-width:700px;
}

/* Mobile optimization */
@media(max-width:768px){
  th, td{
    white-space:nowrap;
    font-size:13px;
    padding:10px;
  }
}


@media(max-width:600px){
  header{font-size:18px}
}
</style>
</head>

<body>

<header>ADMIN – ONLINE ASSESSMENT PLATFORM</header>

<div class="container">

<!-- ================= CREATE / EDIT EXAM ================= -->
<div class="card">
<h3>Create / Edit Exam</h3>
<div class="grid">
<input id="exam_id" placeholder="Exam ID">
<input id="exam_name" placeholder="Exam Name">
<input id="partA_count" placeholder="Part A (1 Mark)">
<input id="partB_count" placeholder="Part B (2 Mark)">
<input id="duration_min" placeholder="Duration (minutes)">
<input id="violation_limit" placeholder="Violation Limit">

<select id="calculator">
  <option value="YES">Calculator Enabled</option>
  <option value="NO">Calculator Disabled</option>
</select>

<select id="review">
  <option value="YES">Review Enabled</option>
  <option value="NO">Review Disabled</option>
</select>

<input id="start_datetime" type="datetime-local">
<input id="end_datetime" type="datetime-local">

<select id="exam_status">
  <option value="ENABLED">Enabled</option>
  <option value="DISABLED">Disabled</option>
</select>
</div>

<button class="btn primary" onclick="createExam()">Create Exam</button>
<button class="btn secondary" onclick="updateExam()">Update Exam Status</button>
</div>

<!-- ================= EXAM LIST ================= -->
<div class="card">
<h3>Created Exams</h3>
<div class="table-scroll">
<table>
<thead>
<tr>
  <th>Exam ID</th>
  <th>Name</th>
  <th>Status</th>
  <th>Start</th>
  <th>End</th>
  <th>Edit</th>
</tr>
</thead>
<tbody id="examTable"></tbody>
</table>
</div>
</div>

<!-- ================= QUESTIONS ================= -->
<div class="card">
<h3>Add Question (Single)</h3>
<div class="grid">
<input id="q_exam_id" placeholder="Exam ID">
<select id="q_part">
  <option value="PART A">PART A</option>
  <option value="PART B">PART B</option>
</select>
<input id="q_qid" placeholder="Question ID">
<input id="q_question" placeholder="Question">
<input id="q_A" placeholder="Option A">
<input id="q_B" placeholder="Option B">
<input id="q_C" placeholder="Option C">
<input id="q_D" placeholder="Option D">
<input id="q_correct" placeholder="Correct (A/B/C/D)">
<input id="q_image" placeholder="Image URL (optional)">
</div>
<button class="btn success" onclick="addSingleQuestion()">Add Question</button>
</div>

<!-- ================= BULK UPLOAD ================= -->
<div class="card">
<h3>Bulk Upload</h3>
<input type="file" id="questionFile" accept=".csv">
<button class="btn primary" onclick="uploadQuestions()">Upload Questions</button>
<button class="btn secondary" onclick="downloadQuestionTemplate()">Question Template</button>

<hr>

<input type="file" id="studentFile" accept=".csv">
<button class="btn primary" onclick="uploadStudents()">Upload Students</button>
<button class="btn secondary" onclick="downloadStudentTemplate()">
  Student Template
</button>
</div>

<!-- ================= EXAM MAPPING ================= -->
<div class="card">
<h3>Bulk Exam – Student Mapping</h3>
<input type="file" id="mapFile" accept=".csv">
<button class="btn primary" onclick="uploadMapping()">Upload Mapping</button>
<button class="btn secondary" onclick="downloadMapTemplate()">Mapping Template</button>
</div>
<!-- ================= RESULTS MANAGEMENT ================= -->
<div class="card">
<h3>Student Results (Re-Enable Control)</h3>

<div class="grid">
  <input id="result_exam_id" placeholder="Enter Exam ID to View Results">
  <button class="btn primary" onclick="loadResults()">Load Results</button>
</div>

<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Exam ID</th>
        <th>Roll No</th>
        <th>Marks</th>
        <th>Violations</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="resultTable"></tbody>
  </table>
</div>

<!-- ================= REPORT ================= -->
<div class="card report-area">
<h3>Exam Report (Print / Export)</h3>

<div class="grid">
<select id="rep_exam_id"></select>
<input id="rep_exam_name" placeholder="Exam Name" readonly>
<select id="rep_dept"></select>
<select id="rep_year"></select>
<select id="rep_section"></select>
</div>

<button class="btn primary" onclick="generateReport()">Generate Report</button>
<button class="btn success" onclick="downloadExcel()">Download Excel</button>
<button class="btn secondary" onclick="downloadPDF()">Download PDF</button>

<div class="table-scroll">
<table id="reportTable">
<thead>
<tr>
<th>S.No</th><th>Roll No</th><th>Student Name</th><th>Total Marks</th><th>Violations</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<!-- ================= LOGOUT ================= -->
<button class="btn danger" onclick="logout()">Logout</button>

  <div class="footer">
    © KCET - ECE Online Examination System
  </div>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbychjIsWyFfKpMR8D4dprb2ud_Ea7ZyEfv613EuoN4lQh-U2NzQ94T8H3upoZMXIkan/exec";

/* ================= CREATE EXAM ================= */
function createExam(){
 if(!exam_id.value){ alert("Exam ID required"); return; }

 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({action:"getAllExams"})
 })
 .then(r=>r.json())
 .then(exams=>{
  const exists = exams.some(e => e[0] === exam_id.value);

  if(exists){
    alert("Exam ID already exists. Use UPDATE.");
    return;
  }

  fetch(WEBAPP_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"createExam",
      exam_id:exam_id.value,
      exam_name:exam_name.value,
      partA_count:partA_count.value,
      partB_count:partB_count.value,
      duration_min:duration_min.value,
      violation_limit:violation_limit.value,
      calculator:calculator.value,
      review:review.value,
      start_datetime:start_datetime.value,
      end_datetime:end_datetime.value
    })
  }).then(()=>{ alert("Exam Created"); loadExams(); });
 });
}


/* ================= UPDATE STATUS ================= */
function updateExam(){
 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({
   action:"updateExamDetails",
   exam_id:exam_id.value,
   exam_name:exam_name.value,
   partA_count:partA_count.value,
   partB_count:partB_count.value,
   duration_min:duration_min.value,
   violation_limit:violation_limit.value,
   calculator:calculator.value,
   review:review.value,
   start_datetime:start_datetime.value,
   end_datetime:end_datetime.value,
   status:exam_status.value
  })
 }).then(()=>{ alert("Exam Updated Successfully"); loadExams(); });
}

function downloadStudentTemplate(){
 downloadCSV(
  "email,password,roll_no,name,dept,year,section",
  "student_upload_template.csv"
 );
}

/* ================= LOAD EXAMS ================= */
function loadExams(){
 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({action:"getAllExams"})
 }).then(r=>r.json()).then(d=>{
  examTable.innerHTML="";
  d.forEach(ex=>{
   examTable.innerHTML+=`
    <tr>
      <td>${ex[0]}</td>
      <td>${ex[1]}</td>
      <td>${ex[10]}</td>
      <td>${ex[8]}</td>
      <td>${ex[9]}</td>
      <td><button class="btn primary" onclick='editExam(${JSON.stringify(ex)})'>Edit</button></td>
    </tr>`;
  });
 });
}

function editExam(ex){
 exam_id.value=ex[0];
 exam_name.value=ex[1];
 partA_count.value=ex[2];
 partB_count.value=ex[3];
 duration_min.value=ex[4];
 violation_limit.value=ex[5];
 calculator.value=ex[6];
 review.value=ex[7];
 start_datetime.value=ex[8];
 end_datetime.value=ex[9];
 exam_status.value=ex[10];
}

/* ================= QUESTIONS ================= */
function addSingleQuestion(){
 const q=[{
  exam_id:q_exam_id.value,part:q_part.value,qid:q_qid.value,
  question:q_question.value,optA:q_A.value,optB:q_B.value,
  optC:q_C.value,optD:q_D.value,correct:q_correct.value,image_url:q_image.value
 }];
 sendBulkQuestions(q);
}

function uploadQuestions(){
 parseCSV(questionFile.files[0],sendBulkQuestions);
}

function sendBulkQuestions(data){
 fetch(WEBAPP_URL,{method:"POST",
  body:new URLSearchParams({action:"bulkQuestions",json:JSON.stringify(data)})
 }).then(()=>alert("Questions Stored"));
}

/* ================= STUDENTS ================= */
function uploadStudents(){
 parseCSV(studentFile.files[0],data=>{
  fetch(WEBAPP_URL,{method:"POST",
   body:new URLSearchParams({action:"bulkStudents",json:JSON.stringify(data)})
  }).then(()=>alert("Students Added"));
 });
}

/* ================= MAPPING ================= */
function uploadMapping(){
  parseCSV(mapFile.files[0],data=>{
    Promise.all(
      data.map(m =>
        fetch(WEBAPP_URL,{
          method:"POST",
          body:new URLSearchParams({
            action:"mapExam",
            exam_id:m.exam_id,
            roll_no:m.roll_no||"",
            dept:m.dept||"",
            year:m.year||"",
            section:m.section||""
          })
        })
      )
    ).then(()=>{
      alert("Mapping Completed Successfully");
    });
  });
}


/* ================= CSV ================= */
function parseCSV(file,cb){
 if(!file){alert("Select CSV");return;}
 const r=new FileReader();
 r.onload=e=>{
  const rows=e.target.result.trim().split("\n");
  const h=rows.shift().split(",");
  const d=rows.map(r=>{
   const o={};
   r.split(",").forEach((v,i)=>o[h[i]]=v.trim());
   return o;
  });
  cb(d);
 };
 r.readAsText(file);
}

/* ================= TEMPLATES ================= */
function downloadQuestionTemplate(){
 downloadCSV("exam_id,part,qid,question,optA,optB,optC,optD,correct,image_url","question_template.csv");
}
function downloadMapTemplate(){
 downloadCSV("exam_id,roll_no,dept,year,section","exam_student_mapping_template.csv");
}
function downloadCSV(csv,name){
 const a=document.createElement("a");
 a.href="data:text/csv;charset=utf-8,"+csv;
 a.download=name;
 a.click();
}

/* ================= LOAD RESULTS ================= */

function loadResults(){

 const exam_id = result_exam_id.value.trim();

 if(!exam_id){
   alert("Please enter Exam ID");
   return;
 }

 fetch(
  WEBAPP_URL + "?action=getResults&exam_id=" + encodeURIComponent(exam_id),
  { method:"POST" }
 )
 .then(r=>r.json())
 .then(d=>{
  resultTable.innerHTML="";

  if(!d || d.length===0){
    resultTable.innerHTML =
      "<tr><td colspan='6'>No Results Found</td></tr>";
    return;
  }

  d.forEach(r=>{
    const exam   = r[0];
    const roll   = r[1];
    const marks  = r[2];
    const vio    = r[3];
    const status = r[4];

    resultTable.innerHTML += `
      <tr>
        <td>${exam}</td>
        <td>${roll}</td>
        <td>${marks}</td>
        <td>${vio}</td>
        <td><b>${status}</b></td>
        <td>
          ${
            status==="SUBMITTED"
            ? `<button class="btn success"
                 onclick="reenable('${exam}','${roll}')">
                 Re-Enable</button>`
            : "-"
          }
        </td>
      </tr>`;
  });
 })
 .catch(err=>{
   console.error(err);
   alert("Error loading results");
 });
}



/* ================= RE-ENABLE ================= */
function reenable(exam_id, roll_no){
 if(!confirm("Re-enable this student?")) return;
 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({
    action:"unblockStudent",
    exam_id,
    roll_no
  })
 }).then(()=>{ alert("Student Re-Enabled"); loadResults(); });
}


  let USERS=[], EXAMS=[], REPORT_DATA=[];

/* ===== LOAD EXAMS ===== */
function loadExams(){
 fetch(WEBAPP_URL,{method:"POST",body:new URLSearchParams({action:"getAllExams"})})
 .then(r=>r.json()).then(d=>{
   EXAMS=d;
   examTable.innerHTML="";
   rep_exam_id.innerHTML='<option value="">Select Exam</option>';
   d.forEach(ex=>{
     examTable.innerHTML+=`
       <tr>
         <td>${ex[0]}</td><td>${ex[1]}</td><td>${ex[10]}</td>
         <td>${ex[8]}</td><td>${ex[9]}</td>
         <td><button class="btn primary" onclick='editExam(${JSON.stringify(ex)})'>Edit</button></td>
       </tr>`;
     rep_exam_id.innerHTML+=`<option>${ex[0]}</option>`;
   });
 });
}

/* ===== USERS ===== */
fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({action:"getAllUsers"})
})
.then(r=>r.json())
.then(d=>{
  USERS = d;

  const DEPTS = new Set();
  const YEARS = new Set();
  const SECTIONS = new Set();

  d.forEach(u=>{
    if(u[5]) DEPTS.add(u[5]);     // ✅ dept
    if(u[6]) YEARS.add(u[6]);     // ✅ year
    if(u[7]) SECTIONS.add(u[7]);  // ✅ section
  });

  rep_dept.innerHTML =
    '<option value="">All Depts</option>' +
    [...DEPTS].map(v=>`<option>${v}</option>`).join("");

  rep_year.innerHTML =
    '<option value="">All Years</option>' +
    [...YEARS].map(v=>`<option>${v}</option>`).join("");

  rep_section.innerHTML =
    '<option value="">All Sections</option>' +
    [...SECTIONS].map(v=>`<option>${v}</option>`).join("");
});


/* ===== REPORT ===== */
rep_exam_id.onchange=()=>{
 const ex=EXAMS.find(e=>e[0]===rep_exam_id.value);
 rep_exam_name.value=ex?ex[1]:"";
};

function generateReport(){

 if(!rep_exam_id.value){
   alert("Select Exam");
   return;
 }

 fetch(
  WEBAPP_URL + "?action=getResults&exam_id=" + rep_exam_id.value,
  { method:"POST" }
 )
 .then(r=>r.json())
 .then(res=>{

   REPORT_DATA=[];
   const tbody = reportTable.querySelector("tbody");
   tbody.innerHTML="";

   let i = 1;

   res.forEach(r=>{

     // ✅ FIXED USER MATCH (roll_no index = 3)
     const u = USERS.find(x => x[3] === r[1]);
     if(!u) return;

     // ✅ FILTERS
     if(rep_dept.value && u[5] !== rep_dept.value) return;
     if(rep_year.value && u[6] !== rep_year.value) return;
     if(rep_section.value && u[7] !== rep_section.value) return;

     REPORT_DATA.push([
       i,
       r[1],      // Roll No
       u[4],      // Student Name
       r[2],      // Marks
       r[3]       // Violations
     ]);

     tbody.innerHTML += `
       <tr>
         <td>${i++}</td>
         <td>${r[1]}</td>
         <td>${u[4]}</td>
         <td>${r[2]}</td>
         <td>${r[3]}</td>
       </tr>`;
   });

   if(!REPORT_DATA.length){
     tbody.innerHTML =
       "<tr><td colspan='5'>No Records Found</td></tr>";
   }

 });
}


/* ===== EXCEL ===== */
function downloadExcel(){

 if(!REPORT_DATA.length){
   alert("Generate report first");
   return;
 }

 const header = [
   ["COLLEGE NAME"],
   [],
   ["Exam ID", rep_exam_id.value],
   ["Exam Name", rep_exam_name.value],
   ["Department", rep_dept.value || "ALL"],
   ["Year", rep_year.value || "ALL"],
   ["Section", rep_section.value || "ALL"],
   [],
   ["S.No","Roll No","Student Name","Marks","Violations"]
 ];

 const ws = XLSX.utils.aoa_to_sheet([
   ...header,
   ...REPORT_DATA
 ]);

 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "Exam Report");

 XLSX.writeFile(wb, "Exam_Report.xlsx");
}


/* ===== PDF ===== */
function downloadPDF(){

 if(!REPORT_DATA.length){
   alert("Generate report first");
   return;
 }

 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 doc.setFont("Times","Normal");

 let y = 15;

 doc.setFontSize(14);
 doc.text("COLLEGE NAME",105,y,{align:"center"});
 y+=8;

 /*doc.setFontSize(11);
 doc.text(`Exam ID: ${rep_exam_id.value}`,14,y); y+=6;
 doc.text(`Exam Name: ${rep_exam_name.value}`,14,y); y+=6;
 doc.text(`Department: ${rep_dept.value || "ALL"}`,14,y); y+=6;
 doc.text(`Year: ${rep_year.value || "ALL"}`,14,y); y+=6;
 doc.text(`Section: ${rep_section.value || "ALL"}`,14,y); y+=8;*/

doc.setFontSize(11);

// Row 1: Exam ID - Exam Name
doc.text(
  `Exam ID: ${rep_exam_id.value} - Exam Name: ${rep_exam_name.value}`,
  14,
  y
);
y += 8;

// Row 2: Department   Section   Year (with spacing)
doc.text(`Department: ${rep_dept.value || "ALL"}`, 14, y);
doc.text(`Section: ${rep_section.value || "ALL"}`, 80, y);
doc.text(`Year: ${rep_year.value || "ALL"}`, 140, y);
y += 8;



// Sort REPORT_DATA by Roll No (column index 1)
REPORT_DATA.sort((a, b) =>
  a[1].localeCompare(b[1], undefined, {
    numeric: true,
    sensitivity: "base"
  })
);

// Re-assign S.No after sorting
REPORT_DATA.forEach((row, index) => {
  row[0] = index + 1;
});

doc.autoTable({
  startY: y,
  head: [["S.No","Roll No","Student Name","Marks","Violations"]],
  body: REPORT_DATA,
  styles:{
    font: "Times",
    fontSize: 10,
    halign: "center"
  },
  headStyles:{
    fillColor: [21,101,192]
  },
  theme: "grid"
});


 /*doc.autoTable({
   startY: y,
   head: [["S.No","Roll No","Student Name","Marks","Violations"]],
   body: REPORT_DATA,
   styles:{
     font:"Times",
     fontSize:10,
     halign:"center"
   },
   headStyles:{
     fillColor:[21,101,192]
   },
   theme:"grid"
 });*/

 doc.save("Exam_Report.pdf");
}


function logout(){
 sessionStorage.clear();
 location.href="index.html";
}

loadExams();

/* ================= LOGOUT ================= */
function logout(){
 sessionStorage.clear();
 location.href="index.html";
}

loadExams();
</script>

</body>
</html>






