<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Answer Review</title>

<style>
:root{
  --bg:#eef2f7;
  --card:#ffffff;
  --text:#000;
  --primary:#0d47a1;
}
body.dark{
  --bg:#121212;
  --card:#1e1e1e;
  --text:#e0e0e0;
}
body{
  margin:0;
  font-family:'Segoe UI',system-ui;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  background:var(--primary);
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:20px;
  font-weight:600;
}
.sub-header{
  background:#e3f2fd;
  padding:10px;
  text-align:center;
  font-size:14px;
}

/* ACTIONS */
.actions{
  display:flex;
  justify-content:center;
  gap:10px;
  padding:10px;
}
.actions button{
  border:none;
  background:var(--primary);
  color:#fff;
  padding:8px 14px;
  border-radius:20px;
  font-size:13px;
  cursor:pointer;
}

/* TABS */
.tabs{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
}
.tab{
  padding:8px 16px;
  border-radius:20px;
  background:#cfd8dc;
  cursor:pointer;
  font-size:13px;
}
.tab.active{
  background:var(--primary);
  color:#fff;
}

/* SECTIONS */
.container{max-width:900px;margin:auto;padding:15px}
.section{display:none}
.section.active{display:block}

/* SUMMARY */
.summary{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.summary-box{
  flex:1;
  background:var(--card);
  padding:14px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 6px 16px rgba(0,0,0,.15);
}

/* CARD */
.card{
  background:var(--card);
  margin:15px 0;
  padding:18px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}
.fade-in{
  opacity:0;
  transform:translateY(10px);
  animation:fade .6s forwards;
}
@keyframes fade{to{opacity:1;transform:none}}

.correct{color:#2e7d32;font-weight:600}
.wrong{color:#c62828;font-weight:600}

/* LOADING */
#loading{
  text-align:center;
  padding:30px;
}
.spinner{
  width:40px;height:40px;
  border:4px solid #bbdefb;
  border-top:4px solid var(--primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}
@keyframes spin{to{transform:rotate(360deg)}}
.progress{
  width:80%;
  height:8px;
  background:#ddd;
  border-radius:10px;
  margin:15px auto;
}
.bar{
  height:100%;
  width:0%;
  background:var(--primary);
  transition:.4s;
}

/* PRINT */
@media print{
  .actions,.tabs{display:none}
  body{background:#fff}
  .card{box-shadow:none}
}
</style>
</head>

<body>

<header>üìÑ Answer Review</header>
<div class="sub-header" id="studentInfo"></div>

<div class="actions">
  <button onclick="toggleDark()">üåô Dark</button>
  <button onclick="window.print()">üñ®Ô∏è Print / PDF</button>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('overall',this)">Overall</div>
  <div class="tab" onclick="showTab('A',this)">Part A</div>
  <div class="tab" onclick="showTab('B',this)">Part B</div>
</div>

<div id="loading">
  <div class="spinner"></div>
  <div id="loadText">Loading‚Ä¶ 0%</div>
  <div class="progress"><div class="bar" id="bar"></div></div>
</div>

<div class="container">
  <div id="overall" class="section active"></div>
  <div id="partA" class="section"></div>
  <div id="partB" class="section"></div>
</div>

<script>
/* DARK MODE */
if(localStorage.dark==="1")document.body.classList.add("dark");
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.dark=document.body.classList.contains("dark")?"1":"0";
}

/* TABS */
function showTab(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(id==="overall"?"overall":id==="A"?"partA":"partB").classList.add('active');
}

/* BACKEND */
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbyjOeC_ggmXAQZhOVQwyEiVhSFLKhSI9SSJfT76-jwpqNf9R_TXEGToplLyyVYGiuEJ/exec";

const exam_id=sessionStorage.getItem("exam_id");
const user=JSON.parse(sessionStorage.getItem("user"));
studentInfo.innerHTML=`üë®‚Äçüéì ${user.name} | üÜî ${user.roll} | üìù Exam ID: ${exam_id}`;

const bar=document.getElementById("bar");
const txt=document.getElementById("loadText");
const setP=p=>{bar.style.width=p+"%";txt.innerText="Loading‚Ä¶ "+p+"%"};

setP(10);

/* FETCH DATA */
Promise.all([
  fetch(WEBAPP_URL,{method:"POST",body:new URLSearchParams({action:"getQuestions",exam_id})})
    .then(r=>{setP(40);return r.json();}),
  fetch(WEBAPP_URL,{method:"POST",body:new URLSearchParams({action:"getResponses",exam_id,roll_no:user.roll})})
    .then(r=>{setP(70);return r.json();})
])
.then(([questions,responses])=>{
  const answers=JSON.parse(responses[0][2]);
  const ids=responses[0][3].split(",").map(x=>x.trim());
  const filtered=questions.filter(q=>ids.includes(String(q[2]).trim()));

  let OC=0,OW=0,ONA=0,OQ=0;
  filtered.forEach(q=>{
    const s=answers[q[2]]||"",c=q[8];
    OQ++; if(!s)ONA++; else if(s===c)OC++; else OW++;
  });

  overall.innerHTML=`
  <div class="summary">
    <div class="summary-box"><strong>${OQ}</strong><br>Total</div>
    <div class="summary-box"><strong>${OC}</strong><br>Correct</div>
    <div class="summary-box"><strong>${OW}</strong><br>Wrong</div>
    <div class="summary-box"><strong>${ONA}</strong><br>NA</div>
  </div>`;

  filtered.forEach((q,i)=>{
    const s=answers[q[2]]||"",ck=q[8];
    const opt={A:q[4],B:q[5],C:q[6],D:q[7]};
    const ok=s===ck;
    const card=`
    <div class="card fade-in">
      <div><strong>Q${i+1}.</strong> ${q[3]}</div>
      <div>Your Answer:
        <span class="${ok?'correct':'wrong'}">${s?opt[s]:"Not Answered"}</span>
      </div>
      <div>Correct Answer:
        <span class="correct">${opt[ck]}</span>
      </div>
    </div>`;
    overall.innerHTML+=card;
    (q[1]==="PART A"?partA:partB).innerHTML+=card;
  });

  setP(100);
  loading.style.display="none";
});
</script>

</body>
</html>
