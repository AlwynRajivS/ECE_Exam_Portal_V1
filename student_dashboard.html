<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --blue:#0d47a1; --blue2:#1976d2;
  --green:#2e7d32; --orange:#ef6c00;
  --gray:#546e7a; --bg:#eef2f7;
}
*{box-sizing:border-box;font-family:'Segoe UI',system-ui}
body{margin:0;background:var(--bg)}

header{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;padding:22px 16px;text-align:center;
  font-size:22px;font-weight:600;
  position:sticky;top:0;z-index:20;
  box-shadow:0 8px 24px rgba(0,0,0,.35);
}
.container{max-width:1200px;margin:auto;padding:20px}

/* ===== OFFLINE BANNER ===== */
#offlineBanner{
  display:none;
  background:#c62828;
  color:#fff;
  padding:10px;
  text-align:center;
  font-size:14px;
  position:sticky;
  top:0;
  z-index:30;
}

/* FOOTER */
.footer{text-align:center;margin-top:18px;font-size:12px;color:#777}

/* PROFILE */
.profile{
  background:#fff;border-radius:26px;padding:24px;
  display:flex;gap:18px;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  margin-bottom:36px;
}
.profile i{font-size:66px;color:var(--blue)}

/* SECTION */
.section{margin-bottom:40px;display:none}
.section-title{
  display:flex;align-items:center;gap:8px;
  font-size:20px;color:var(--blue)
}

/* CARD */
.exam-card{
  background:#fff;border-radius:30px;
  padding:30px 26px 26px;margin-bottom:24px;
  box-shadow:0 20px 44px rgba(0,0,0,.18);
  position:relative;text-align:center;
  animation:fadeUp .5s ease both;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:none}
}

/* STATUS */
.status-badge{
  position:absolute;top:18px;right:18px;
  padding:6px 14px;font-size:12px;
  font-weight:700;color:#fff;border-radius:20px;
}
.status-live{background:#2e7d32}
.status-upcoming{background:#ef6c00}
.status-completed{background:#546e7a}

/* META */
.meta{
  margin:18px auto;padding:18px;
  border-radius:20px;background:#e3f2fd;
  max-width:420px;text-align:left;
}
.meta .row{display:flex;gap:10px;margin:8px 0;font-weight:600;color:#0d47a1}
.meta .total{
  margin-top:10px;padding-top:10px;
  border-top:2px dashed #90caf9;
  font-size:18px;font-weight:800;color:#2e7d32;
}

/* BUTTONS */
.btn{
  padding:16px;border:none;border-radius:30px;
  font-size:16px;cursor:pointer;color:#fff;
  display:flex;gap:10px;align-items:center;
  justify-content:center;width:100%;margin-top:14px;
}
.start{background:#2e7d32}
.review{background:#1976d2}
.logout{background:#c62828;margin-top:30px}

/* EMPTY */
.empty{
  background:#fff;padding:26px;border-radius:26px;
  text-align:center;color:#777;
  box-shadow:0 10px 22px rgba(0,0,0,.14);
}

/* ===== LOADING ===== */
#loading{margin-bottom:30px}
.progress-wrap{
  height:6px;background:#cfd8dc;border-radius:6px;
  overflow:hidden;margin-bottom:18px;
}
#progress{
  height:100%;width:0%;
  background:linear-gradient(90deg,#1976d2,#2e7d32);
  transition:width .4s ease;
}
.skeleton-card{
  background:#fff;border-radius:26px;
  height:220px;margin-bottom:20px;
  position:relative;overflow:hidden;
}
.skeleton-card::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 37%,#f0f0f0 63%);
  animation:shimmer 1.4s infinite;
}
@keyframes shimmer{
  0%{transform:translateX(-100%)}
  100%{transform:translateX(100%)}
}
</style>
</head>

<body>

<div id="offlineBanner">
 <i class="fa-solid fa-wifi"></i> You are offline. Showing last saved data.
</div>

<header>
 <i class="fa-solid fa-user-graduate"></i>
 Student Examination Portal
</header>

<div class="container">

<div class="profile" id="profile"></div>

<div id="loading">
 <div class="progress-wrap"><div id="progress"></div></div>
 <div class="skeleton-card"></div>
 <div class="skeleton-card"></div>
 <div class="skeleton-card"></div>
</div>

<div class="section" id="liveSection">
 <h3 class="section-title"><i class="fa-solid fa-bolt"></i> Live Exams</h3>
 <div id="live" class="empty"></div>
</div>

<div class="section" id="upcomingSection">
 <h3 class="section-title"><i class="fa-solid fa-calendar"></i> Scheduled Exams</h3>
 <div id="upcoming" class="empty"></div>
</div>

<div class="section" id="completedSection">
 <h3 class="section-title"><i class="fa-solid fa-check"></i> Completed Exams</h3>
 <div id="completed" class="empty"></div>
</div>

<button class="btn logout" onclick="logout()">
 <i class="fa-solid fa-right-from-bracket"></i> Logout
</button>

<div class="footer">Â© KCET - ECE Online Examination System</div>
</div>

<script>
/* ===== RESTORE FIX ===== */
window.addEventListener("pageshow",e=>{
 if(e.persisted) location.reload();
});

/* ===== OFFLINE BANNER ===== */
function updateOnlineStatus(){
 document.getElementById("offlineBanner").style.display =
   navigator.onLine ? "none" : "block";
}
window.addEventListener("online",updateOnlineStatus);
window.addEventListener("offline",updateOnlineStatus);
updateOnlineStatus();

/* ===== ORIGINAL SCRIPT (UNCHANGED LOGIC) ===== */
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbzQAZuTBNRUdr86h0xC3C_KSj5M7-AC4ObFlMeGov_j9na-iOnmaCFMJqrauw1ad0Ra/exec";
const user=JSON.parse(sessionStorage.getItem("user"));
if(!user) location.href="index.html";

profile.innerHTML=`
<i class="fa-solid fa-circle-user"></i>
<div>
<h3>${user.name}</h3>
<p>${user.roll} | ${user.dept}</p>
<p>${user.year} - ${user.section}</p>
</div>`;

let p=10;
const bar=document.getElementById("progress");
const progTimer=setInterval(()=>{
 p=Math.min(p+Math.random()*15,90);
 bar.style.width=p+"%";
},400);

const fetchWithTimeout=(data,t=8000)=>Promise.race([
 fetch(WEBAPP_URL,{method:"POST",body:data}).then(r=>r.json()),
 new Promise((_,rej)=>setTimeout(()=>rej("timeout"),t))
]);

const cE=sessionStorage.getItem("cached_exams");
const cR=sessionStorage.getItem("cached_results");
let rendered=false;
if(cE&&cR){
 try{
  renderExams(JSON.parse(cE),JSON.parse(cR));
  rendered=true;
 }catch{}
}

Promise.all([
 fetchWithTimeout(new URLSearchParams({action:"getStudentExams",roll:user.roll})),
 fetchWithTimeout(new URLSearchParams({action:"getResults"}))
])
.then(([exams,results])=>{
 sessionStorage.setItem("cached_exams",JSON.stringify(exams));
 sessionStorage.setItem("cached_results",JSON.stringify(results));
 if(!rendered) renderExams(exams,results);
})
.catch(()=>{
 loading.innerHTML='<div class="empty">Network slow. Please refresh.</div>';
});

function renderExams(exams,results){
 clearInterval(progTimer);
 bar.style.width="100%";
 loading.style.display="none";

 liveSection.style.display=upcomingSection.style.display=completedSection.style.display="block";
 live.innerHTML=upcoming.innerHTML=completed.innerHTML="";

 exams.forEach(e=>{
  const a=+e[2],b=+e[3],t=a+b*2;
  const at=results.filter(r=>r[0]===e[0]&&r[1]===user.roll);
  const last=at.length?at[at.length-1][4]:null;
  const now=new Date(),s=new Date(e[8]),en=new Date(e[9]);

  if(last==="SUBMITTED"){completed.innerHTML+=completedCard(e,"COMPLETED",a,b,t);return;}
  if(last==="RE-ENABLED"||(now>=s&&now<=en&&!at.length)){live.innerHTML+=liveCard(e,a,b,t);return;}
  if(now<s){upcoming.innerHTML+=upcomingCard(e,s,a,b,t);return;}
  completed.innerHTML+=completedCard(e,"CLOSED",a,b,t);
 });

 if(!live.innerHTML)live.innerHTML='<div class="empty">No live exams</div>';
 if(!upcoming.innerHTML)upcoming.innerHTML='<div class="empty">No scheduled exams</div>';
 if(!completed.innerHTML)completed.innerHTML='<div class="empty">No completed exams</div>';
}

const meta=(a,b,t)=>`
<div class="meta">
 <div class="row">Part A: ${a}</div>
 <div class="row">Part B: ${b}</div>
 <div class="row total">Total: ${t}</div>
</div>`;

const liveCard=(e,a,b,t)=>`
<div class="exam-card">
 <div class="status-badge status-live">LIVE</div>
 <h4>${e[1]}</h4><p>Exam ID: ${e[0]}</p>
 ${meta(a,b,t)}
 <button class="btn start" onclick="startExam('${e[0]}')">
  <i class="fa-solid fa-play"></i> Start Exam
 </button>
</div>`;

const upcomingCard=(e,s,a,b,t)=>`
<div class="exam-card">
 <div class="status-badge status-upcoming">SCHEDULED</div>
 <h4>${e[1]}</h4><p>Exam ID: ${e[0]}</p>
 <p>Starts: ${s.toLocaleString()}</p>
 ${meta(a,b,t)}
</div>`;

function completedCard(e,msg,a,b,t){
 return `
<div class="exam-card">
 <div class="status-badge status-completed">COMPLETED</div>
 <h4>${e[1]}</h4><p>Exam ID: ${e[0]}</p><p>${msg}</p>
 ${meta(a,b,t)}
</div>`;}

function startExam(id){sessionStorage.setItem("exam_id",id);location.href="instructions.html";}
function logout(){sessionStorage.clear();location.href="index.html";}
</script>

</body>
</html>
