<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --blue:#0d47a1;
  --blue2:#1976d2;
  --green:#2e7d32;
  --orange:#ef6c00;
  --gray:#546e7a;
  --bg:#eef2f7;
}
*{box-sizing:border-box;font-family:'Segoe UI',system-ui}
body{margin:0;background:var(--bg)}

header{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;
  padding:22px 16px;
  text-align:center;
  font-size:22px;
  font-weight:600;
  position:sticky;top:0;z-index:20;
  box-shadow:0 8px 24px rgba(0,0,0,.35);
}
.container{max-width:1200px;margin:auto;padding:20px}

/* FOOTER */
.footer{text-align:center;margin-top:18px;font-size:12px;color:#777}

/* PROFILE */
.profile{
  background:#fff;border-radius:26px;padding:24px;
  display:flex;gap:18px;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  margin-bottom:36px;
}
.profile i{font-size:66px;color:var(--blue)}

/* SECTION */
.section{margin-bottom:40px}
.section-title{
  display:flex;align-items:center;gap:8px;
  font-size:20px;color:var(--blue);
}

/* CARD */
.exam-card{
  background:#fff;border-radius:30px;
  padding:30px 26px;margin-bottom:24px;
  box-shadow:0 20px 44px rgba(0,0,0,.18);
  position:relative;text-align:center;
  opacity:0;transform:translateY(20px);
  animation:fadeUp .5s ease forwards;
}
@keyframes fadeUp{
  to{opacity:1;transform:none}
}

/* STATUS */
.status-badge{
  position:absolute;top:18px;right:18px;
  padding:6px 14px;font-size:12px;
  font-weight:700;color:#fff;border-radius:20px;
}
.status-live{background:#2e7d32;animation:pulse 2.4s infinite}
.status-upcoming{background:#ef6c00}
.status-completed{background:#546e7a}
@keyframes pulse{
  0%{box-shadow:0 0 0 rgba(46,125,50,.4)}
  50%{box-shadow:0 0 22px rgba(46,125,50,.7)}
  100%{box-shadow:0 0 0 rgba(46,125,50,.4)}
}

/* META */
.meta{
  margin:18px auto;padding:18px;border-radius:20px;
  background:#e3f2fd;max-width:420px;text-align:left;
}
.meta .row{display:flex;gap:10px;margin:8px 0;font-weight:600;color:#0d47a1}
.meta .total{margin-top:10px;border-top:2px dashed #90caf9;
  padding-top:10px;font-size:18px;font-weight:800;color:#2e7d32}

/* BUTTON */
.btn{
  padding:16px;border:none;border-radius:30px;
  font-size:16px;cursor:pointer;color:#fff;
  display:flex;gap:10px;align-items:center;
  justify-content:center;width:100%;margin-top:14px;
}
.start{background:#2e7d32}
.review{background:#1976d2}
.logout{background:#c62828;margin-top:30px}

/* EMPTY / LOADING */
.empty{
  background:#fff;padding:26px;border-radius:26px;
  text-align:center;color:#777;
  box-shadow:0 10px 22px rgba(0,0,0,.14);
}

/* SKELETON */
.skeleton{
  height:120px;border-radius:26px;
  background:linear-gradient(90deg,#eee,#f5f5f5,#eee);
  animation:shimmer 1.4s infinite;
  margin-bottom:24px;
}
@keyframes shimmer{
  0%{background-position:-400px}
  100%{background-position:400px}
}

/* PROGRESS BAR */
.progress{
  height:4px;background:#bbdefb;
  overflow:hidden;border-radius:4px;margin-bottom:16px;
}
.progress span{
  display:block;height:100%;
  width:0;background:#1976d2;
  animation:load 3s linear infinite;
}
@keyframes load{to{width:100%}}

/* MOBILE */
@media(max-width:600px){
  .profile{flex-direction:column;text-align:center}
}
</style>
</head>

<body>

<header>
 <i class="fa-solid fa-user-graduate"></i> Student Examination Portal
</header>

<div class="container">

<div class="profile" id="profile"></div>

<div class="progress" id="progress"><span></span></div>

<div class="section">
 <h3 class="section-title"><i class="fa-solid fa-bolt"></i> Live Exams</h3>
 <div id="live"></div>
</div>

<div class="section">
 <h3 class="section-title"><i class="fa-solid fa-calendar"></i> Scheduled Exams</h3>
 <div id="upcoming"></div>
</div>

<div class="section">
 <h3 class="section-title"><i class="fa-solid fa-check"></i> Completed Exams</h3>
 <div id="completed"></div>
</div>

<button class="btn logout" onclick="logout()">
 <i class="fa-solid fa-right-from-bracket"></i> Logout
</button>

<div class="footer">Â© KCET - ECE Online Examination System</div>
</div>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbzQAZuTBNRUdr86h0xC3C_KSj5M7-AC4ObFlMeGov_j9na-iOnmaCFMJqrauw1ad0Ra/exec";
const user=JSON.parse(sessionStorage.getItem("user"));

profile.innerHTML=`
<i class="fa-solid fa-circle-user"></i>
<div>
<h3>${user.name}</h3>
<p>${user.roll} | ${user.dept}</p>
<p>${user.year} - ${user.section}</p>
</div>`;

/* SKELETON INIT */
["live","upcoming","completed"].forEach(id=>{
 document.getElementById(id).innerHTML=
   '<div class="skeleton"></div><div class="skeleton"></div>';
});

/* TIMEOUT */
const timeout=setTimeout(()=>{
 document.getElementById("progress").style.display="none";
 ["live","upcoming","completed"].forEach(id=>{
   document.getElementById(id).innerHTML=
    '<div class="empty">Slow connection. Please refresh.</div>';
 });
},8000);

/* CACHE */
const cache=sessionStorage.getItem("exam_cache");
if(cache){
 renderData(JSON.parse(cache));
}

/* FETCH */
Promise.all([
 fetch(WEBAPP_URL,{method:"POST",body:new URLSearchParams({action:"getStudentExams",roll:user.roll})}).then(r=>r.json()),
 fetch(WEBAPP_URL,{method:"POST",body:new URLSearchParams({action:"getResults"})}).then(r=>r.json())
]).then(data=>{
 clearTimeout(timeout);
 sessionStorage.setItem("exam_cache",JSON.stringify(data));
 renderData(data);
});

function renderData([exams,results]){
 document.getElementById("progress").style.display="none";
 live.innerHTML=""; upcoming.innerHTML=""; completed.innerHTML="";

 exams.forEach(e=>{
  const a=+e[2],b=+e[3],t=a+b*2;
  const at=results.filter(r=>r[0]===e[0]&&r[1]===user.roll);
  const last=at.length?at.at(-1)[4]:null;
  const now=new Date(),s=new Date(e[8]),en=new Date(e[9]);

  if(last==="SUBMITTED"){completed.innerHTML+=completedCard(e,"COMPLETED",a,b,t);return;}
  if(last==="RE-ENABLED"||(!at.length&&now>=s&&now<=en)){live.innerHTML+=liveCard(e,a,b,t);return;}
  if(now<s){upcoming.innerHTML+=upcomingCard(e,s,a,b,t);return;}
  completed.innerHTML+=completedCard(e,"CLOSED",a,b,t);
 });

 if(!live.innerHTML)live.innerHTML='<div class="empty">No live exams</div>';
 if(!upcoming.innerHTML)upcoming.innerHTML='<div class="empty">No scheduled exams</div>';
 if(!completed.innerHTML)completed.innerHTML='<div class="empty">No completed exams</div>';
}

/* CARD BUILDERS (UNCHANGED LOGIC) */
const meta=(a,b,t)=>`
<div class="meta">
 <div class="row">Part A: ${a}</div>
 <div class="row">Part B: ${b}</div>
 <div class="row total">Total: ${t}</div>
</div>`;

const liveCard=(e,a,b,t)=>`
<div class="exam-card">
 <div class="status-badge status-live">LIVE</div>
 <h4>${e[1]}</h4><p>Exam ID: ${e[0]}</p>
 ${meta(a,b,t)}
 <button class="btn start" onclick="startExam('${e[0]}')">
  <i class="fa-solid fa-play"></i> Start Exam
 </button>
</div>`;

const upcomingCard=(e,s,a,b,t)=>`
<div class="exam-card">
 <div class="status-badge status-upcoming">SCHEDULED</div>
 <h4>${e[1]}</h4>
 <p>Starts: ${s.toLocaleString()}</p>
 ${meta(a,b,t)}
</div>`;

function completedCard(e,msg,a,b,t){
 return `
 <div class="exam-card">
  <div class="status-badge status-completed">COMPLETED</div>
  <h4>${e[1]}</h4><p>${msg}</p>
  ${meta(a,b,t)}
 </div>`;
}

/* NAV */
function startExam(id){sessionStorage.setItem("exam_id",id);location.href="instructions.html";}
function logout(){sessionStorage.clear();location.href="index.html";}
</script>

</body>
</html>
