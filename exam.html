<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Examination</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
 --blue:#0d47a1; --green:#2e7d32;
 --orange:#fb8c00; --red:#c62828;
 --gray:#78909c; --bg:#eef2f7;
}
*{box-sizing:border-box;font-family:'Segoe UI',system-ui}
body{margin:0;background:var(--bg)}

header{
 position:sticky;top:0;z-index:50;
 background:linear-gradient(135deg,#0d47a1,#1976d2);
 color:#fff;padding:14px 18px;
 display:flex;justify-content:space-between;
 align-items:center;
 box-shadow:0 6px 20px rgba(0,0,0,.35)
}
header .grp{display:flex;gap:14px;align-items:center}

.progress{height:6px;background:#bbdefb}
.progress span{display:block;height:100%;background:#2e7d32;width:0%}

.main{display:flex;min-height:90vh}
.qbox{flex:1;background:#fff;padding:28px}
.palette{
 width:260px;background:#f7f9fc;
 padding:18px;border-left:1px solid #ddd
}

.section{
 background:#e3f2fd;color:#0d47a1;
 padding:6px 14px;border-radius:16px;
 font-weight:600;display:inline-block
}

.option{
 background:#e3f2fd;padding:14px;
 border-radius:14px;margin:12px 0;
 cursor:pointer
}
.option:hover{background:#bbdefb}
.option.selected{
 background:linear-gradient(135deg,#2e7d32,#66bb6a);
 color:#fff
}

.controls{margin-top:26px}
.btn{
 padding:12px 20px;border:none;
 border-radius:14px;color:#fff;
 cursor:pointer;font-size:14px;
 display:inline-flex;gap:8px;align-items:center
}
.next{background:#1976d2}
.mark{background:#fb8c00}
.submit{background:#c62828}

.palette span{
 width:36px;height:36px;
 display:inline-block;margin:6px;
 border-radius:50%;text-align:center;
 line-height:36px;color:#fff;
 background:#b0bec5;font-weight:600;
 cursor:pointer
}
.answered{background:#2e7d32!important}
.review{background:#fb8c00!important}

#loading{
 font-size:18px;color:#78909c;
 text-align:center;padding:40px 0
}
</style>
</head>

<body>

<header>
 <div class="grp">
  <i class="fa-solid fa-user-graduate"></i>
  <span id="studentInfo"></span>
 </div>
 <div class="grp">
  ⏱ <span id="timer">00:00</span>
  ⚠ <span id="vio">0 / 0</span>
 </div>
</header>

<div class="progress"><span id="bar"></span></div>

<div class="main">
 <div class="qbox">
  <div id="loading">⏳ Loading questions…</div>
  <div id="question"></div>

  <div class="controls">
   <button class="btn mark" onclick="markReview()">
    <i class="fa-solid fa-bookmark"></i> Review
   </button>
   <button class="btn next" onclick="nextQ()">
    <i class="fa-solid fa-arrow-right"></i> Next
   </button>
   <button class="btn submit" onclick="submitExam()">
    <i class="fa-solid fa-paper-plane"></i> Submit
   </button>
  </div>
 </div>

 <div class="palette" id="palette"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbxmFdZlBq4m_7SvJtVF9NbyGC-c_of2aqokQtyg81aH97WPo6AT56VvwKYGG_tz4XEq/exec";

const user = JSON.parse(sessionStorage.getItem("user"));
const exam_id = sessionStorage.getItem("exam_id");
studentInfo.innerText = `${user.name} (${user.roll})`;

let questions=[], index=0, answers={}, duration=0;
let violations=0, limit=0, partA=0, partB=0;

/* ================= SAFE SHUFFLE ================= */
function shuffle(arr){
 for(let i=arr.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [arr[i],arr[j]]=[arr[j],arr[i]];
 }
 return arr;
}

/* ================= LOAD EXAM META ================= */
fetch(WEBAPP_URL,{
 method:"POST",
 body:new URLSearchParams({action:"getExamMeta",exam_id})
})
.then(r=>r.json())
.then(m=>{
 duration = m.duration * 60;
 limit = m.violation_limit;
 vio.innerText = `0 / ${limit}`;
 partA = m.partA;
 partB = m.partB;
});

/* ================= LOAD QUESTIONS ================= */
fetch(WEBAPP_URL,{
 method:"POST",
 body:new URLSearchParams({action:"getQuestions",exam_id})
})
.then(r=>r.json())
.then(allQ=>{
 const A = shuffle(allQ.filter(q=>q[1]==="PART A")).slice(0,partA);
 const B = shuffle(allQ.filter(q=>q[1]==="PART B")).slice(0,partB);
 questions = A.concat(B);

 if(!sessionStorage.getItem("qSignature")){
  sessionStorage.setItem("qSignature",
   questions.map(q=>q[2]).join(","));
 }

 document.getElementById("loading").style.display="none";
 drawPalette();

 setTimeout(()=>{
  restoreState();
  loadQ();
  startTimer();
 },0);
});

/* ================= RENDER QUESTION ================= */
function loadQ(){
 if(!questions.length) return;

 if(index<0) index=0;
 if(index>=questions.length) index=questions.length-1;

 const q = questions[index];
 if(!q) return;

 question.innerHTML=`
  <span class="section">${q[1]}</span>
  <h3>Q${index+1}. ${q[3]}</h3>
  ${["A","B","C","D"].map((o,i)=>`
   <div class="option ${answers[index]?.ans===o?"selected":""}"
    onclick="selectAns('${o}')">${q[4+i]}</div>
  `).join("")}
 `;

 bar.style.width=((index+1)/questions.length*100)+"%";
}

/* ================= ANSWERS ================= */
function selectAns(a){
 answers[index]={qid:questions[index][2],ans:a};
 document.getElementById("p"+index).classList.add("answered");
 saveState();
 loadQ();
}

/* ================= PALETTE ================= */
function drawPalette(){
 palette.innerHTML="";
 questions.forEach((_,i)=>{
  palette.innerHTML+=
   `<span id="p${i}" onclick="index=${i};loadQ()">${i+1}</span>`;
 });
}
function markReview(){
 document.getElementById("p"+index).classList.add("review");
}
function nextQ(){
 if(index<questions.length-1){
  index++; saveState(); loadQ();
 }
}

/* ================= TIMER ================= */
function startTimer(){
 setInterval(()=>{
  const m=Math.floor(duration/60);
  const s=duration%60;
  timer.innerText=`${m}:${String(s).padStart(2,"0")}`;
  duration--;
  saveState();
  if(duration<0) submitExam();
 },1000);
}

/* ================= SAVE / RESTORE ================= */
function saveState(){
 sessionStorage.setItem("answers",JSON.stringify(answers));
 sessionStorage.setItem("index",index);
 sessionStorage.setItem("timeLeft",duration);
 sessionStorage.setItem("violations",violations);
}

function restoreState(){
 if(!questions.length) return;

 const sig=sessionStorage.getItem("qSignature");
 const cur=questions.map(q=>q[2]).join(",");

 if(sig!==cur){
  sessionStorage.clear();
  return;
 }

 answers=JSON.parse(sessionStorage.getItem("answers")||"{}");
 index=Math.min(Number(sessionStorage.getItem("index")||0),questions.length-1);
 duration=Number(sessionStorage.getItem("timeLeft")||duration);
 violations=Number(sessionStorage.getItem("violations")||0);
 vio.innerText=`${violations} / ${limit}`;
}

/* ================= SUBMIT ================= */
function submitExam(){
 const final={};
 questions.forEach((q,i)=>{
  final[q[2]]=answers[i]?.ans||"";
 });

 fetch(WEBAPP_URL,{
  method:"POST",
  body:new URLSearchParams({
   action:"submitExam",
   exam_id,
   roll_no:user.roll,
   answers_json:JSON.stringify(final)
  })
 }).then(()=>location.href="summary.html");
}
</script>
</body>
</html>
